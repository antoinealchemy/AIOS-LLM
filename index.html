<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS LLM</title>
        <!-- Auth Protection -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseClient = window.supabase.createClient(
            'https://oxjocjucvlifcogphttm.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9janVjdmxpZmNvZ3BodHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTk4NDEsImV4cCI6MjA4MTc5NTg0MX0.Fg9r0RSt-KSkePeIVIBCdVydPIcLsdWFa6D7V5bMT6E'
        );

        (async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/login.html';
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F8F8F8;
            --bg-secondary: #FFFFFF;
            --bg-chat: #F8F8F8;
            --text-primary: #1a1a1a;
            --text-secondary: #6C6C6C;
            --border-color: #E5E7EB;
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --message-user: #FFFFFF;
            --message-ai: #FFFFFF;
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #171717;
            --bg-chat: #1a1a1a;
            --text-primary: #fafafa;
            --text-secondary: #a3a3a3;
            --border-color: #262626;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --message-user: #262626;
            --message-ai: #171717;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            min-height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            letter-spacing: -0.02em;
            font-weight: 400;
        }

        .app-wrapper {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .theme-toggle {
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .theme-icon {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 0;
            background: var(--bg-chat);
        }

        .messages {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message.user .message-avatar {
            background: var(--accent);
            color: white;
        }

        .message.ai .message-avatar {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-content {
            flex: 1;
            background: var(--message-ai);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            line-height: 1.6;
            font-size: 0.9375rem;
        }

        .message.user .message-content {
            background: var(--message-user);
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .message-content h1:first-child,
        .message-content h2:first-child,
        .message-content h3:first-child {
            margin-top: 0;
        }

        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.1rem; }

        .message-content p {
            margin-bottom: 1rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            margin-top: 0.5rem;
        }

        .message-content li {
            margin-bottom: 0.375rem;
        }

        .message-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: var(--bg-primary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
        }

        .message-content pre {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            border: none;
            font-size: 0.875rem;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.25rem 0;
            font-size: 0.9375rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .message-content th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .message-content tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .message-content tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .message-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
        }

        .message-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }

        .input-container {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0 2rem;
            position: relative;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .input-wrapper.dragging {
            background: var(--bg-chat);
            border-radius: 12px;
        }

        .input-wrapper.dragging .chat-input {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .chat-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 8rem 1rem 3.125rem;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.9375rem;
            color: var(--text-primary);
            resize: none;
            outline: none;
            transition: all 0.2s ease;
            min-height: 52px;
            max-height: 320px;
            letter-spacing: -0.01em;
            overflow-y: auto;
        }

        .chat-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-button {
            position: absolute;
            right: 2.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            min-width: 36px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .send-button:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .mic-button {
            position: absolute;
            right: calc(2rem + 52px);
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            min-width: 36px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .mic-button:hover {
            background: var(--bg-chat);
        }

        .mic-button.recording {
            background: #ef4444;
        }

        .mic-button svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .mic-button.recording svg {
            stroke: white;
        }

        .rag-toggle-btn {
            position: absolute;
            right: calc(2rem + 104px);
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            min-width: 36px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .rag-toggle-btn:hover {
            background: var(--bg-chat);
        }

        .rag-toggle-btn.active {
            background: var(--accent);
        }

        .rag-toggle-btn.active svg {
            stroke: white;
        }

        .rag-toggle-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .rag-indicator {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            right: calc(2rem + 104px);
            background: var(--accent);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 5;
            font-weight: 500;
        }

        .attach-button {
            position: absolute;
            left: 0.625rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            min-width: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            z-index: 2;
        }

        .attach-button:hover {
            background: var(--bg-chat);
        }

        .attach-button svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .file-preview {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            left: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .file-preview-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-preview-icon {
            font-size: 1.25rem;
        }

        .file-preview-name {
            font-size: 0.875rem;
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-preview-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .file-preview-remove:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .audio-visualizer {
            position: absolute;
            left: 1rem;
            right: 6rem;
            top: 50%;
            transform: translateY(-50%);
            height: 52px;
            background: var(--bg-primary);
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
            z-index: 10;
            overflow: hidden;
        }

        .audio-visualizer.active {
            display: flex;
        }

        .audio-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.05s ease;
            height: 4px;
            min-height: 4px;
        }

        .audio-controls {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 0.5rem;
            align-items: center;
            z-index: 11;
        }

        .audio-controls.active {
            display: flex;
        }

        .audio-cancel, .audio-submit {
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .audio-cancel:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .audio-submit {
            background: transparent;
            border: 2px solid var(--accent);
        }

        .audio-submit:hover {
            background: var(--accent);
        }

        .audio-submit:hover svg {
            stroke: white;
        }

        .audio-cancel svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2.2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .audio-submit svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .empty-state {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .suggestion-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .suggestion-card h3 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .suggestion-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-toggle {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            z-index: 101;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-secondary);
        }

        .sidebar-toggle svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2.5;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 0.5rem;
            padding-right: 2.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-height: 44px;
        }

        .new-chat-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            color: var(--text-primary);
            width: 100%;
            margin: 0.5rem;
            font-size: 0.875rem;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .new-chat-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .sidebar.collapsed .new-chat-btn {
            padding: 0.75rem;
            justify-content: center;
        }

        .sidebar.collapsed .new-chat-btn span {
            display: none;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .sidebar.collapsed .chats-list {
            display: none;
        }

        .chat-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
        }

        .chat-item.active {
            background: var(--bg-secondary);
        }

        .chat-item-title {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-actions {
            display: none;
            align-items: center;
            gap: 0.25rem;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
        }

        .chat-action-btn {
            padding: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar.collapsed .sidebar-footer {
            padding: 0.5rem;
        }

        .app-wrapper {
            margin-left: 260px;
            height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed ~ .app-wrapper {
            margin-left: 60px;
        }

        .documents-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-secondary);
            z-index: 1000;
            overflow-y: auto;
        }

        .documents-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9375rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: var(--bg-secondary);
        }

        .documents-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .documents-content {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .upload-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .upload-section h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .upload-zone svg {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .upload-zone p {
            color: var(--text-secondary);
            margin: 0;
        }

        .text-upload h4 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .doc-name-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            margin-bottom: 1rem;
            font-family: inherit;
        }

        .doc-name-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .upload-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upload-btn:hover {
            opacity: 0.9;
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9375rem;
        }

        .upload-status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: rgb(34, 197, 94);
        }

        .upload-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: rgb(239, 68, 68);
        }

        .documents-list-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        .documents-list-section h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .loading-docs {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .doc-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .doc-item:hover {
            border-color: var(--accent);
        }

        .doc-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .doc-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .doc-meta {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1rem;
        }

        .doc-actions {
            display: flex;
            gap: 0.5rem;
        }

        .doc-delete-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .doc-delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgb(239, 68, 68);
            color: rgb(239, 68, 68);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
            </button>
        </div>
        
        <button class="new-chat-btn" id="newChatBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Nouveau chat</span>
        </button>
        
        <button class="new-chat-btn" id="documentsBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <span>Documents</span>
        </button>
        
        <div class="chats-list" id="chatsList"></div>
        
        <div class="sidebar-footer">
            <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem 0;">
                <span id="userEmail" style="font-size: 0.75rem; color: var(--text-secondary); text-align: center;"></span>
                <button class="new-chat-btn" id="logoutBtn" style="background: var(--bg-primary); color: var(--text-primary); padding: 0.5rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>D√©connexion</span>
                </button>
            </div>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <svg id="themeIcon" class="theme-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </div>
    </div>

    <div class="app-wrapper">
        <div class="chat-container" id="chatContainer">
            <div class="messages" id="messages">
                <div class="empty-state" id="emptyState">
                    <h2>Bonjour, comment puis-je vous aider ?</h2>
                    <p>Posez n'importe quelle question sur votre entreprise, vos clients ou vos projets.</p>
                    <div class="suggestions">
                        <div class="suggestion-card" onclick="useSuggestion('R√©sume mon dernier appel avec le client ABC')">
                            <h3>R√©sum√© d'appel</h3>
                            <p>Obtenez un r√©sum√© de vos derni√®res conversations clients</p>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('Quels sont les projets en cours pour janvier ?')">
                            <h3>Projets en cours</h3>
                            <p>Vue d'ensemble de vos projets et deadlines</p>
                        </div>
                        <div class="suggestion-card" onclick="useSuggestion('Analyse les performances du trimestre')">
                            <h3>Analyse performance</h3>
                            <p>Insights sur vos m√©triques cl√©s</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Posez votre question..."
                    rows="1"
                ></textarea>
                
                <div class="file-preview" id="filePreview" style="display: none;">
                    <div class="file-preview-content">
                        <span class="file-preview-icon">üìé</span>
                        <span class="file-preview-name" id="filePreviewName"></span>
                        <button class="file-preview-remove" id="filePreviewRemove">‚úï</button>
                    </div>
                </div>

                <div class="rag-indicator" id="ragIndicator" style="display: none;">
                    üîç RAG activ√©
                </div>
                
                <input type="file" id="chatAttachInput" accept="image/*,.pdf,.txt,.docx,.md,.json,.xml,.xlsx,.xls,.csv" style="display: none;">
                
                <div class="audio-visualizer" id="audioVisualizer">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>

                <div class="audio-controls" id="audioControls">
                    <button class="audio-cancel" id="audioCancelBtn" aria-label="Cancel recording">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <button class="audio-submit" id="audioSubmitBtn" aria-label="Submit recording">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                </div>

                <button class="attach-button" id="attachButton" aria-label="Attach file">
                    <svg viewBox="0 0 24 24">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </button>
                <button class="rag-toggle-btn" id="ragToggleBtn" aria-label="Toggle RAG">
                    <svg viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
                <button class="mic-button" id="micButton" aria-label="Voice input">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
                <button class="send-button" id="sendButton" aria-label="Send message">
                    <svg viewBox="0 0 24 24">
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="documents-page" id="documentsPage" style="display: none;">
        <div class="documents-header">
            <button class="back-btn" id="backToChat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour au chat
            </button>
            <h2>Gestion des Documents</h2>
        </div>

        <div class="documents-content">
            <div class="upload-section">
                <h3>Upload Document</h3>
                
                <div class="upload-zone" id="fileUploadZone">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p>Glissez un fichier ici ou cliquez pour s√©lectionner</p>
                    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.xml,.md,.json,.csv,.xlsx,.xls" style="display: none;">
                </div>

                <div class="text-upload">
                    <h4>ou saisir du texte directement</h4>
                    <input type="text" id="docName" placeholder="Nom du document" class="doc-name-input">
                    <textarea id="textInput" placeholder="Collez votre texte ici..." class="text-input"></textarea>
                    <button id="uploadTextBtn" class="upload-btn">Uploader le texte</button>
                </div>
            </div>

            <div class="documents-list-section">
                <h3>Documents upload√©s</h3>
                <div id="documentsList" class="documents-list">
                    <div class="loading-docs">Chargement...</div>
                </div>
            </div>

            <div class="upload-status" id="uploadStatus" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://aios-llm-backend.onrender.com';

        // ========== AUTH HELPER FUNCTION ==========
        // ‚úÖ AUTH ADDED
        async function getAuthHeaders() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/login.html';
                return {};
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            };
        }

        // ‚úÖ AUTH ADDED
        async function loadChats() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats`, { headers });
                const data = await response.json();
                
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = '';
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        const chatItem = createChatItem(chat);
                        chatsList.appendChild(chatItem);
                    });
                    
                    if (!currentChatId) {
                        const urlChatId = getCurrentChatIdFromUrl();
                        const targetId = urlChatId || data.chats[0].id;
                        loadChat(targetId);
                    }
                } else {
                    await createNewChat();
                }
            } catch (error) {
                console.error('Load chats error:', error);
            }
        }

        function createChatItem(chat) {
            const div = document.createElement('div');
            div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            div.dataset.chatId = chat.id;
            
            div.innerHTML = `
                <div class="chat-item-title">${chat.title}</div>
                <div class="chat-item-actions">
                    <button class="chat-action-btn" onclick="deleteChat('${chat.id}')" title="Supprimer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-action-btn')) {
                    loadChat(chat.id);
                }
            });
            
            return div;
        }

        // ‚úÖ AUTH ADDED
        async function createNewChat() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ title: 'Nouvelle conversation' })
                });
                
                const data = await response.json();
                await loadChats();
                loadChat(data.chat.id);
            } catch (error) {
                console.error('Create chat error:', error);
            }
        }

        // ‚úÖ AUTH ADDED
        async function loadChat(chatId) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats/${chatId}`, { headers });
                const data = await response.json();
                
                currentChatId = chatId;
                updateUrl(chatId);
                
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.chatId === chatId);
                });
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                    });
                } else {
                    showEmptyState();
                }
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Load chat error:', error);
            }
        }

        // ‚úÖ AUTH ADDED
        async function deleteChat(chatId) {
            if (!confirm('Supprimer cette conversation ?')) return;
            
            try {
                const headers = await getAuthHeaders();
                await fetch(`${API_URL}/api/chats/${chatId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                if (currentChatId === chatId) {
                    currentChatId = null;
                }
                
                await loadChats();
            } catch (error) {
                console.error('Delete chat error:', error);
            }
        }

        // ‚úÖ AUTH ADDED
        async function saveMessage(role, content) {
            if (!currentChatId) {
                await createNewChat();
            }
            
            try {
                const headers = await getAuthHeaders();
                
                await fetch(`${API_URL}/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ role, content })
                });
                
                const messages = document.querySelectorAll('.message');
                if (messages.length === 2 && role === 'user') {
                    const title = content.slice(0, 50) + (content.length > 50 ? '...' : '');
                    
                    const headers2 = await getAuthHeaders();
                    await fetch(`${API_URL}/api/chats/${currentChatId}`, {
                        method: 'PUT',
                        headers: headers2,
                        body: JSON.stringify({ title })
                    });
                    refreshSidebar();
                }
            } catch (error) {
                console.error('Save message error:', error);
            }
        }
        
        // ‚úÖ AUTH ADDED
        async function refreshSidebar() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats`, { headers });
                const data = await response.json();
                
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = '';
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        const chatItem = createChatItem(chat);
                        chatsList.appendChild(chatItem);
                    });
                }
            } catch (error) {
                console.error('Refresh sidebar error:', error);
            }
        }

        const sidebar = document.querySelector('.sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
        }

        function showEmptyState() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="empty-state" id="emptyState">
                    <h2>Bonjour, comment puis-je vous aider ?</h2>
                    <p>Posez n'importe quelle question sur votre entreprise, vos clients ou vos projets.</p>
                </div>
            `;
        }

        document.getElementById('newChatBtn').addEventListener('click', createNewChat);

        loadChats();

        window.addEventListener('hashchange', () => {
            const urlChatId = getCurrentChatIdFromUrl();
            if (urlChatId && urlChatId !== currentChatId) {
                loadChat(urlChatId);
            }
        });

        const documentsBtn = document.getElementById('documentsBtn');
        const backToChat = document.getElementById('backToChat');
        const documentsPage = document.getElementById('documentsPage');
        const appWrapper = document.querySelector('.app-wrapper');

        documentsBtn.addEventListener('click', () => {
            appWrapper.style.display = 'none';
            documentsPage.style.display = 'block';
            loadDocuments();
        });

        backToChat.addEventListener('click', () => {
            documentsPage.style.display = 'none';
            appWrapper.style.display = 'flex';
        });

        async function loadDocuments() {
            const documentsList = document.getElementById('documentsList');
            documentsList.innerHTML = '<div class="loading-docs">Chargement...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/documents`);
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    documentsList.innerHTML = '';
                    data.documents.forEach(doc => {
                        const docItem = createDocumentItem(doc);
                        documentsList.appendChild(docItem);
                    });
                } else {
                    documentsList.innerHTML = '<div class="loading-docs">Aucun document upload√©</div>';
                }
            } catch (error) {
                console.error('Load documents error:', error);
                documentsList.innerHTML = '<div class="loading-docs" style="color: rgb(239, 68, 68);">Erreur chargement documents</div>';
            }
        }
        
        function createDocumentItem(doc) {
            const div = document.createElement('div');
            div.className = 'doc-item';
            
            const uploadDate = new Date(doc.uploadedAt).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            div.innerHTML = `
                <div class="doc-info">
                    <div class="doc-name">${doc.source}</div>
                    <div class="doc-meta">
                        <span>üìÖ ${uploadDate}</span>
                        <span>üì¶ ${doc.chunkCount} chunk${doc.chunkCount > 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div class="doc-actions">
                    <button class="doc-delete-btn" onclick="editDocument('${doc.id}')" style="background: transparent; border-color: var(--accent); color: var(--accent);">
                        Modifier
                    </button>
                    <button class="doc-delete-btn" onclick="deleteDocument('${doc.id}')">
                        Supprimer
                    </button>
                </div>
            `;
            
            return div;
        }
        
        async function editDocument(docId) {
            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.querySelector('.upload-section').scrollIntoView({ behavior: 'smooth' });
                    
                    docName.value = data.source;
                    textInput.value = data.text;
                    
                    textInput.dataset.editingId = docId;
                    
                    uploadTextBtn.textContent = 'Mettre √† jour le document';
                    uploadTextBtn.style.background = '#f59e0b';
                    
                    showStatus(`üìù √âdition de "${data.source}"`, 'success');
                } else {
                    showStatus(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Edit document error:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        async function deleteDocument(docId) {
            if (!confirm('Supprimer ce document d√©finitivement ?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ Document supprim√© (${data.deletedChunks} chunks)`, 'success');
                    loadDocuments();
                } else {
                    showStatus(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Delete document error:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        const fileUploadZone = document.getElementById('fileUploadZone');
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const docName = document.getElementById('docName');
        const uploadTextBtn = document.getElementById('uploadTextBtn');
        const uploadStatus = document.getElementById('uploadStatus');

        fileUploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadZone.style.borderColor = 'var(--accent)';
            fileUploadZone.style.background = 'var(--bg-secondary)';
        });

        fileUploadZone.addEventListener('dragleave', () => {
            fileUploadZone.style.borderColor = '';
            fileUploadZone.style.background = '';
        });

        fileUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadZone.style.borderColor = '';
            fileUploadZone.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showStatus(`Upload de "${file.name}" en cours...`, 'success');
                
                const response = await fetch(`${API_URL}/api/upload-file`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ ${data.message}`, 'success');
                    loadDocuments();
                    fileInput.value = '';
                } else {
                    showStatus(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        uploadTextBtn.addEventListener('click', async () => {
            const text = textInput.value.trim();
            const name = docName.value.trim() || `doc-${Date.now()}`;
            const editingId = textInput.dataset.editingId;
            
            if (!text) {
                showStatus('Veuillez saisir du texte', 'error');
                return;
            }
            
            if (editingId) {
                uploadTextBtn.disabled = true;
                showStatus('Mise √† jour en cours...', 'success');
                
                try {
                    await fetch(`${API_URL}/api/documents/${editingId}`, {
                        method: 'DELETE'
                    });
                    
                    const docId = editingId;
                    await uploadDocument(docId, text, name);
                    
                    setTimeout(() => {
                        showStatus('‚ÑπÔ∏è La mise √† jour peut prendre ~1 minute (propagation Pinecone)', 'success');
                    }, 2000);
                    
                    delete textInput.dataset.editingId;
                    uploadTextBtn.textContent = 'Uploader le texte';
                    uploadTextBtn.style.background = '';
                    
                } catch (error) {
                    console.error('Update error:', error);
                    showStatus(`‚ùå Erreur mise √† jour: ${error.message}`, 'error');
                    uploadTextBtn.disabled = false;
                }
            } else {
                const docId = `text-${Date.now()}-${name.replace(/[^a-z0-9]/gi, '-')}`;
                await uploadDocument(docId, text, name);
            }
        });

        async function uploadDocument(id, text, source) {
            uploadTextBtn.disabled = true;
            showStatus('Upload en cours...', 'success');
            
            try {
                const response = await fetch('http://localhost:3000/api/upload-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        text: text,
                        source: source
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ Document "${source}" ajout√© avec succ√®s !`, 'success');
                    
                    textInput.value = '';
                    docName.value = '';
                    fileInput.value = '';
                    
                    loadDocuments();
                } else {
                    showStatus(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            } finally {
                uploadTextBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 5000);
            }
        }

        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        const sunIcon = `<circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
        
        const moonIcon = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;

        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        updateThemeUI(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        });

        function updateThemeUI(theme) {
            if (theme === 'dark') {
                themeIcon.innerHTML = sunIcon;
            } else {
                themeIcon.innerHTML = moonIcon;
            }
        }

        function getCurrentChatIdFromUrl() {
            const hash = window.location.hash;
            const match = hash.match(/#\/chat\/([a-f0-9-]+)/);
            return match ? match[1] : null;
        }

        function updateUrl(chatId) {
            const newHash = chatId ? `#/chat/${chatId}` : '#/';
            window.location.hash = newHash;
        }

        const CHAT_API_URL = API_URL + '/api/chat';
        const conversationId = 'session-' + Date.now();

        let ragForceEnabled = false;
        const ragToggleBtn = document.getElementById('ragToggleBtn');
        const ragIndicator = document.getElementById('ragIndicator');

        ragToggleBtn.addEventListener('click', () => {
            ragForceEnabled = !ragForceEnabled;
            
            if (ragForceEnabled) {
                ragToggleBtn.classList.add('active');
                ragIndicator.style.display = 'block';
            } else {
                ragToggleBtn.classList.remove('active');
                ragIndicator.style.display = 'none';
            }
        });

        async function sendToGemini(userMessage) {
            try {
                const loadingId = addLoadingMessage();

                const response = await fetch(CHAT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        conversationId: conversationId,
                        forceRAG: ragForceEnabled,
                        chatId: currentChatId,
                    })
                });

                removeLoadingMessage(loadingId);

                // ========== GESTION ERREUR LIMITE CHAT ==========
                if (!response.ok) {
                    const errorData = await response.json();
                    
                    if (errorData.error === 'chat_limit_reached') {
                        // Chat limite atteinte ‚Üí Force nouveau chat
                        addSystemMessage(
                            '‚ö†Ô∏è Ce chat a atteint la limite de 200 messages.\n\n' +
                            '**Action requise :** Cr√©ez un nouveau chat pour continuer.\n\n' +
                            'üí° *Bonne pratique : 1 chat = 1 sujet*',
                            'background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 1.25rem; border-radius: 8px; margin-top: 1rem;'
                        );
                        
                        // Disable input
                        chatInput.disabled = true;
                        chatInput.placeholder = '‚ö†Ô∏è Chat plein - Cr√©ez un nouveau chat';
                        sendButton.disabled = true;
                        
                        // Focus bouton nouveau chat
                        setTimeout(() => {
                            document.getElementById('newChatBtn').classList.add('pulse');
                        }, 500);
                        
                        return;
                    }
                    
                    throw new Error(`API Error: ${response.status}`);
                }
                // ========== END ERROR HANDLING ==========

                const data = await response.json();
                const aiResponse = data.response;

                addMessage(aiResponse, 'ai');
                
                // Affiche warnings UI si pr√©sents
                if (data.uiMessage) {
                    const styles = {
                        'info': 'background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 1rem; border-radius: 8px; margin-top: 1rem;',
                        'warning': 'background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-top: 1rem;',
                        'error': 'background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 1rem; border-radius: 8px; margin-top: 1rem;'
                    };
                    
                    addSystemMessage(data.uiMessage.text, styles[data.uiMessage.type] || styles.info);
                }
                
                await saveMessage('assistant', aiResponse);

                // Reset RAG toggle
                if (ragForceEnabled) {
                    ragForceEnabled = false;
                    ragToggleBtn.classList.remove('active');
                    ragIndicator.style.display = 'none';
                }

            } catch (error) {
                console.error('API Error:', error);
                removeLoadingMessage(loadingId);
                addMessage("D√©sol√©, une erreur s'est produite. Veuillez r√©essayer.", 'ai');
            }
        }

        // Fonction message syst√®me (si pas d√©j√† pr√©sente)
        function addSystemMessage(text, style) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '‚öôÔ∏è';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.style.cssText = style;
            content.innerHTML = marked.parse(text); // Support Markdown
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendToGeminiWithFile(userMessage, file) {
            try {
                const loadingId = addLoadingMessage();

                const formData = new FormData();
                formData.append('message', userMessage);
                formData.append('conversationId', conversationId);
                formData.append('chatId', currentChatId);
                formData.append('file', file);

                const response = await fetch(API_URL + '/api/chat-with-file', {
                    method: 'POST',
                    body: formData
                });

                removeLoadingMessage(loadingId);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.response;

                addMessage(aiResponse, 'ai');
                await saveMessage('assistant', aiResponse);

            } catch (error) {
                console.error('API Error:', error);
                removeLoadingMessage(loadingId);
                addMessage("D√©sol√©, une erreur s'est produite lors de l'analyse du fichier. Veuillez r√©essayer.", 'ai');
            }
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.id = 'loading-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<span style="opacity: 0.6;">En train d\'analyser...</span>';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
            return 'loading-message';
        }

        function removeLoadingMessage(id) {
            const loadingMsg = document.getElementById(id);
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messages');
        const emptyState = document.getElementById('emptyState');
        const chatContainer = document.getElementById('chatContainer');
        const attachButton = document.getElementById('attachButton');
        const chatAttachInput = document.getElementById('chatAttachInput');
        const filePreview = document.getElementById('filePreview');
        const filePreviewName = document.getElementById('filePreviewName');
        const filePreviewRemove = document.getElementById('filePreviewRemove');

        let attachedFile = null;

        attachButton.addEventListener('click', () => {
            chatAttachInput.click();
        });

        chatAttachInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                attachedFile = e.target.files[0];
                filePreviewName.textContent = attachedFile.name;
                filePreview.style.display = 'flex';
            }
        });

        filePreviewRemove.addEventListener('click', () => {
            attachedFile = null;
            chatAttachInput.value = '';
            filePreview.style.display = 'none';
        });

        const inputWrapper = document.querySelector('.input-wrapper');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => {
                inputWrapper.classList.add('dragging');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => {
                inputWrapper.classList.remove('dragging');
            }, false);
        });

        inputWrapper.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                attachedFile = files[0];
                filePreviewName.textContent = attachedFile.name;
                filePreview.style.display = 'flex';
                
                chatInput.focus();
            }
        }, false);

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            const newHeight = Math.min(chatInput.scrollHeight, 320);
            chatInput.style.height = newHeight + 'px';
            
            if (chatInput.scrollHeight > 320) {
                chatInput.style.overflowY = 'auto';
            } else {
                chatInput.style.overflowY = 'hidden';
            }
        });

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
                if (currentTranscript.trim()) {
                    sendMessage();
                }
            } else {
                sendMessage();
            }
        });

        const micButton = document.getElementById('micButton');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const audioControls = document.getElementById('audioControls');
        
        let recognition = null;
        let isRecording = false;
        let currentTranscript = '';

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                micButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>`;
                sendButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>`;
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                currentTranscript = (finalTranscript + interimTranscript).trim();
                chatInput.value = currentTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                }
            };

            micButton.addEventListener('click', () => {
                if (isRecording) {
                    currentTranscript = '';
                    chatInput.value = '';
                    stopRecording();
                } else {
                    currentTranscript = '';
                    chatInput.value = '';
                    recognition.start();
                }
            });

            function stopRecording() {
                isRecording = false;
                recognition.stop();
                
                micButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>`;
                sendButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>`;
            }
        } else {
            micButton.style.display = 'none';
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message && !attachedFile) return;

            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.remove();
            }

            let displayMessage = message;
            if (attachedFile) {
                displayMessage = `üìé ${attachedFile.name}\n${message}`;
            }

            addMessage(displayMessage, 'user');
            await saveMessage('user', displayMessage);

            chatInput.value = '';
            chatInput.style.height = 'auto';

            if (attachedFile) {
                await sendToGeminiWithFile(message, attachedFile);
                
                attachedFile = null;
                chatAttachInput.value = '';
                filePreview.style.display = 'none';
            } else {
                await sendToGemini(message);
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'AI';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            if (sender === 'ai') {
                content.innerHTML = marked.parse(text);
            } else {
                content.textContent = text;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function useSuggestion(text) {
            chatInput.value = text;
            chatInput.focus();
            sendMessage();
        }

        // Display user email + logout
        (async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                document.getElementById('userEmail').textContent = user.email;
            }
        })();

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = '/login.html';
        });
    </script>
</body>
</html>