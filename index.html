<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS LLM</title>
        <!-- Auth Protection -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseClient = window.supabase.createClient(
            'https://oxjocjucvlifcogphttm.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9janVjdmxpZmNvZ3BodHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTk4NDEsImV4cCI6MjA4MTc5NTg0MX0.Fg9r0RSt-KSkePeIVIBCdVydPIcLsdWFa6D7V5bMT6E'
        );

        // ========== BOOTSTRAP UTILISATEUR CENTRALISÉ ==========
        window.currentUser = null;

        async function bootstrapUser() {
            try {
                // 1. Vérifier session Supabase
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    console.log('❌ Pas de session → redirect login');
                    window.location.href = '/login.html';
                    return false;
                }

                console.log('✅ Session valide:', session.user.id);

                // 2. Charger le profil depuis public.users
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                // 3. GESTION ÉTAT CRITIQUE: Auth OK mais pas de ligne public.users
                if (userError || !userData) {
                    console.error('❌ ÉTAT INVALIDE: Session Auth OK mais pas de profil public.users');
                    console.error('Erreur:', userError);
                    
                    await supabaseClient.auth.signOut();
                    alert('Votre compte est incomplet. Veuillez vous réinscrire.');
                    window.location.href = '/signup.html';
                    return false;
                }

                // 4. Profil chargé avec succès
                window.currentUser = userData;
                console.log('✅ Profil chargé depuis public.users:', window.currentUser);

                return true;
                
            } catch (error) {
                console.error('❌ Erreur bootstrap:', error);
                await supabaseClient.auth.signOut();
                window.location.href = '/login.html';
                return false;
            }
        }

        // ========== INITIALISATION APP ==========
        (async () => {
            // 1. Bootstrap utilisateur (BLOQUANT)
            const bootstrapOK = await bootstrapUser();
            if (!bootstrapOK) return;

            console.log('✅ Bootstrap terminé, currentUser disponible');

            // 2. Détecter nouveau chat via URL
            const urlParams = new URLSearchParams(window.location.search);
            let forceNewChat = false;
            
            if (urlParams.get('new') === '1') {
                currentChatId = null;
                localStorage.removeItem('currentChatId');
                forceNewChat = true;
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, '', cleanUrl);
            }
            
            // 3. Charger permissions (maintenant currentUser existe)
            await loadUserPermissions();
            
            // 4. ✅ ÉTAPE 3: Mettre à jour UI avec prénom + nom
            updateUserMenu();
            updateGreeting();
            
            // 5. Initialiser quota
            initQuotaCount();
            
            // 6. Charger chats
            await loadChats(forceNewChat);
            
            // 7. Cacher loader
            const loader = document.getElementById('appLoader');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.2s ease';
                setTimeout(() => loader.remove(), 200);
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FFFFFF;
            --bg-secondary: #FFFFFF;
            --bg-chat: #FFFFFF;
            --text-primary: #1F1F1F;
            --text-secondary: #64748B;
            --border-color: #E5E7EB;
            --accent: #007AFF;
            --accent-hover: #0051D5;
            --accent-light: #E0F2FE;
            --message-user: #F5F5F5;
            --message-ai: #FFFFFF;
        }

        [data-theme="dark"] {
            --bg-primary: #0F1419;
            --bg-secondary: #1A2332;
            --bg-chat: #0F1419;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --border-color: #2D3748;
            --accent: #007AFF;
            --accent-hover: #0051D5;
            --accent-light: #1E3A8A;
            --message-user: #1A2332;
            --message-ai: #0F1419;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: -0.03em;
        }

        html, body {
            width: 100%;
            min-height: 100%;
            overflow-x: hidden;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            font-weight: 400;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app-wrapper {
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* ✅ Empêche scroll horizontal */
            overflow-y: visible; /* ✅ Laisse tooltips sortir verticalement */
        }

        /* === EMPTY STATE : CENTRAGE IDENTIQUE À page.html === */
        
        /* Bloc vertical centré */
        .messages:has(.empty-state:only-child) {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            flex: 1;
        }

        /* Texte centré */
        .empty-state {
            padding: 0;
            margin-bottom: 2rem;
            text-align: center;
            max-width: 800px;
        }

        .empty-state h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: 1.125rem;
            margin-bottom: 0;
        }

        /* Input fait partie du bloc centré */
        .messages:has(.empty-state:only-child) ~ .input-container {
            padding: 0;
            position: static;
        }

        /* Largeur identique */
        .input-center {
            max-width: 800px;
            margin: 0 auto;
        }

        .theme-toggle {
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .theme-icon {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            background: var(--bg-chat);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .messages {
            overflow-y: visible;
            max-width: 800px;
            margin: 0 auto;
            padding-top: 2rem;
            padding-right: 1rem;
            padding-bottom: calc(1.5rem + 70px);
            padding-left: 1rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
        }

        .message {
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
            margin-bottom: 1rem;
            position: relative;
        }
        
        /* Messages AI = alignés à gauche, fond transparent */
        .message.ai {
            align-items: flex-start;
        }
        
        /* Messages User = alignés à droite, fond coloré */
        .message.user {
            align-items: flex-end;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cacher les avatars */
        .message-avatar {
            display: none;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: auto;
        }
        
        /* AI messages = transparent, aucun padding latéral */
        .message.ai .message-content {
            background: transparent;
            border: none;
            padding: 0.5rem 0;
            max-width: 100%;
            border-radius: 0;
        }

        /* User messages = bulle ovale, arrondie, sans bordure */
        .message.user .message-content {
            background: var(--message-user);
            border: none;
            max-width: 70%;
            padding: 0.5rem 1.25rem;
            border-radius: 20px;
        }
        
        /* Actions au survol (heure + copier) - EN DESSOUS */
        .message-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-left: 0;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .message.user .message-actions {
            padding-left: 0;
        }
        
        /* Inverser ordre pour messages AI : copier puis heure */
        .message.ai .message-actions {
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-time {
            opacity: 0.7;
        }
        
        .message-copy-btn {
            background: transparent;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .message-copy-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .message-copy-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .message-file-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            font-size: 0.8125rem;
            width: fit-content;
        }
        
        .message-file-badge svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .message-content h1:first-child,
        .message-content h2:first-child,
        .message-content h3:first-child {
            margin-top: 0;
        }

        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.1rem; }

        .message-content p {
            margin-bottom: 1rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            margin-top: 0.5rem;
        }

        .message-content li {
            margin-bottom: 0.375rem;
        }

        .message-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: var(--bg-primary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
        }

        .message-content pre {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            border: none;
            font-size: 0.875rem;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.25rem 0;
            font-size: 0.9375rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .message-content th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .message-content tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .message-content tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .message-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
        }

        .message-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }

        .input-container {
            padding: 1.5rem 0;
            background: var(--bg-chat);
            transition: all 0.3s ease;
            overflow: visible; /* ✅ Laisse tooltips sortir */
        }

        .input-center {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
            width: 100%;
            overflow: visible; /* ✅ Laisse tooltips sortir */
        }

        .input-wrapper {
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            min-height: 52px;
            padding: 12px;
            overflow: visible;
        }
        
        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        .input-wrapper.dragging {
            background: var(--bg-chat);
            border-color: var(--accent);
        }

        .input-wrapper.dragging .prompt-input {
            background: var(--bg-secondary);
        }
        
        .input-text-area {
            position: relative;
            display: flex;
            align-items: flex-end;
            width: 100%;
            gap: 8px;
        }

        /* Zone scrollable (textarea + attach) */
        .input-scroll-area {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            overflow: visible;
        }

        /* Zone fixe (boutons droite) */
        .input-actions {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        /* === PROMPT INPUT CONTAINER (scroll ICI maintenant) === */
        .prompt-input-container {
            flex: 1;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .prompt-input-container::-webkit-scrollbar {
            width: 4px;
        }

        .prompt-input-container::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
        }

        .prompt-input-container::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 2px;
            opacity: 0.5;
        }

        .prompt-input-container::-webkit-scrollbar-thumb:hover {
            opacity: 1;
        }

        /* Textarea (AUCUN scroll ici) */
        .prompt-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            overflow: hidden !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 24px;
        }

        .prompt-input::placeholder {
            color: var(--text-secondary);
        }

        .send-button {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-bottom: 4px;
        }

        .send-button:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .mic-button {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-bottom: 4px;
            position: relative;
        }

        .mic-button:hover {
            background: var(--bg-chat);
        }
        
        .mic-button::after {
            content: 'Dicter';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 100;
        }
        
        .mic-button:hover::after {
            opacity: 1;
        }

        .mic-button.recording {
            background: #ef4444;
        }

        .mic-button svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .mic-button.recording svg {
            stroke: white;
        }

        .rag-toggle-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-bottom: 4px;
            position: relative;
        }

        .rag-toggle-btn:hover {
            background: var(--bg-chat);
        }
        
        .rag-toggle-btn::after {
            content: 'Recherche avancée';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 100;
        }
        
        .rag-toggle-btn:hover::after {
            opacity: 1;
        }

        .rag-toggle-btn.active {
            background: var(--accent);
        }

        .rag-toggle-btn.active svg {
            stroke: white;
        }

        .rag-toggle-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .rag-indicator {
            position: absolute;
            bottom: calc(100% + 0.5rem);
            right: calc(0.5rem + 92px);
            background: var(--accent);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 5;
            font-weight: 500;
        }

        .attach-button {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-bottom: 4px;
            outline: none;
            position: relative;
        }

        .attach-button:hover {
            background: var(--bg-chat);
        }
        
        .attach-button:focus {
            outline: none;
            box-shadow: none;
        }
        
        .attach-button::after {
            content: 'Ajouter des fichiers';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 100;
        }
        
        .attach-button:hover::after {
            opacity: 1;
        }

        .attach-button svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .file-badge-container {
            display: flex;
            width: 100%;
        }

        .file-preview {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin: 0.5rem 0.5rem 0.25rem 0.5rem;
            width: fit-content;
            max-width: calc(100% - 1rem);
        }

        .file-preview-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-preview-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .file-preview-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .file-preview-name {
            font-size: 0.8125rem;
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .file-preview-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .file-preview-remove:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .input-wrapper-with-files {
            width: 100%;
        }

        .audio-visualizer {
            position: absolute;
            left: 1rem;
            right: 6rem;
            top: 50%;
            transform: translateY(-50%);
            height: 52px;
            background: var(--bg-primary);
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
            z-index: 10;
            overflow: hidden;
        }

        .audio-visualizer.active {
            display: flex;
        }

        .audio-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.05s ease;
            height: 4px;
            min-height: 4px;
        }

        .audio-controls {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 0.5rem;
            align-items: center;
            z-index: 11;
        }

        .audio-controls.active {
            display: flex;
        }

        .audio-cancel, .audio-submit {
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .audio-cancel:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .audio-submit {
            background: transparent;
            border: 2px solid var(--accent);
        }

        .audio-submit:hover {
            background: var(--accent);
        }

        .audio-submit:hover svg {
            stroke: white;
        }

        .audio-cancel svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2.2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .audio-submit svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .empty-state {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            padding: 4rem 2rem;
            position: relative;
            z-index: 20;
        }

        .empty-state h2 {
            font-family: 'Lora', serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.25rem;
        }
        
        /* Positionnement fixe du texte pour alignement parfait avec input */
        .empty-state {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .suggestion-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .suggestion-card h3 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .suggestion-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-toggle {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            z-index: 101;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-secondary);
        }

        .sidebar-toggle svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2.5;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 0.5rem;
            padding-right: 2.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-height: 44px;
        }

        .new-chat-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            color: var(--text-primary);
            width: 100%;
            margin: 0.5rem;
            font-size: 0.875rem;
            text-decoration: none;
        }

        a.new-chat-btn {
            display: flex;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .new-chat-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .sidebar.collapsed .new-chat-btn {
            padding: 0.75rem;
            justify-content: center;
        }

        .sidebar.collapsed .new-chat-btn span {
            display: none;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .sidebar.collapsed .chats-list {
            display: none;
        }

        .chat-item-wrapper {
            position: relative;
            margin-bottom: 0.25rem;
        }

        .chat-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0;
            color: inherit;
            text-decoration: none;
            position: relative;
            transform: none;
        }

        a.chat-item {
            display: flex;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
            transform: none;
        }

        .chat-item.active {
            background: var(--bg-secondary);
        }

        .chat-item-title {
            flex: 1;
            min-width: 0;
            font-size: 0.875rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        
        .chat-item-title span {
            display: inline-block;
        }
        
        .chat-item-title.typing::after {
            content: "▍";
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .chat-item-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            width: 28px;
            justify-content: flex-end;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .chat-item:hover .chat-item-actions {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .chat-menu-btn {
            padding: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            transition: background 0.2s;
        }

        .chat-menu-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .chat-context-menu {
            position: absolute;
            right: 0.5rem;
            top: 100%;
            margin-top: 0.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            pointer-events: none;
        }

        .chat-context-menu.active {
            display: block;
            pointer-events: auto;
        }

        .chat-context-menu-item {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }

        .chat-context-menu-item:hover {
            background: var(--bg-secondary);
        }

        .chat-context-menu-item.delete {
            color: #ef4444;
            border-top: 1px solid var(--border-color);
        }

        .chat-context-menu-item.delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .chat-action-btn {
            padding: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-action-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            position: relative;
        }

        .sidebar.collapsed .sidebar-footer {
            padding: 0.5rem;
        }

        /* Bouton utilisateur (trigger) */
        .user-menu-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
        }

        .user-menu-trigger:hover {
            background: var(--bg-secondary);
        }

        /* Avatar (bulle avec initiale) */
        .user-avatar {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 300;
            font-size: 0.875rem;
        }

        .user-name {
            flex: 1;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Popover menu */
        .user-menu-popover {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0.75rem;
            right: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            z-index: 1000;
        }

        .user-menu-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name-popover {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-email-popover {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 0;
        }

        .user-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-align: left;
        }

        .user-menu-item:hover {
            background: var(--bg-primary);
        }

        .user-menu-item svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .app-wrapper {
            height: 100vh;
            transition: all 0.3s ease;
        }

        .documents-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-secondary);
            z-index: 1000;
            overflow-y: auto;
        }

        .documents-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9375rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: var(--bg-secondary);
        }

        .documents-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .documents-content {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .upload-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .upload-section h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .upload-zone svg {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .upload-zone p {
            color: var(--text-secondary);
            margin: 0;
        }

        .text-upload h4 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .doc-name-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            margin-bottom: 1rem;
            font-family: inherit;
        }

        .doc-name-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .upload-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upload-btn:hover {
            opacity: 0.9;
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9375rem;
        }

        .upload-status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: rgb(34, 197, 94);
        }

        .upload-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: rgb(239, 68, 68);
        }

        .documents-list-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        .documents-list-section h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .loading-docs {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .doc-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .doc-item:hover {
            border-color: var(--accent);
        }

        .doc-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .doc-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .doc-meta {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1rem;
        }

        .doc-actions {
            display: flex;
            gap: 0.5rem;
        }

        .doc-delete-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .doc-delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgb(239, 68, 68);
            color: rgb(239, 68, 68);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="appLoader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    ">
        <div style="text-align: center;">
            <div style="
                width: 40px;
                height: 40px;
                border: 3px solid var(--border-color);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin: 0 auto 1rem;
            "></div>
            <p style="color: var(--text-secondary); font-size: 0.875rem;">Chargement...</p>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Popup custom de confirmation */
        .custom-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.15s ease;
        }

        .custom-confirm-overlay.show {
            display: flex;
        }

        .custom-confirm-dialog {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .custom-confirm-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .custom-confirm-message {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .custom-confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .custom-confirm-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-confirm-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .custom-confirm-btn.cancel:hover {
            background: var(--bg-hover);
        }

        .custom-confirm-btn.confirm {
            background: #ef4444;
            color: white;
        }

        .custom-confirm-btn.confirm:hover {
            background: #dc2626;
        }
    </style>

    <!-- Popup custom de confirmation -->
    <div class="custom-confirm-overlay" id="customConfirm">
        <div class="custom-confirm-dialog">
            <div class="custom-confirm-title" id="confirmTitle">Confirmer</div>
            <div class="custom-confirm-message" id="confirmMessage">Êtes-vous sûr ?</div>
            <div class="custom-confirm-actions">
                <button class="custom-confirm-btn cancel" id="confirmCancel">Annuler</button>
                <button class="custom-confirm-btn confirm" id="confirmOk">Supprimer</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24">
                    <path d="M15 18l-6-6 6-6"></path>
                </svg>
            </button>
        </div>
        
        <a href="/?new=1" class="new-chat-btn" id="newChatBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Nouveau chat</span>
        </a>
        
        <a href="/documents.html" class="new-chat-btn" id="documentsBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <span>Documents</span>
        </a>
        
        <!-- ❌ ÉTAPE 1: Bouton Paramètres supprimé de la sidebar -->
        <!-- L'admin sera accessible uniquement via le menu utilisateur -->
        
        <div class="chats-list" id="chatsList"></div>
        
        <div class="sidebar-footer">
            <!-- Bouton utilisateur (toute la largeur cliquable) -->
            <button class="user-menu-trigger" id="userMenuTrigger">
                <div class="user-avatar">
                    <span id="userInitial"></span>
                </div>
                <span class="user-name" id="userName"></span>
            </button>
            
            <!-- Menu popover (caché par défaut) -->
            <div class="user-menu-popover" id="userMenuPopover" style="display: none;">
                <div class="user-menu-header">
                    <div class="user-avatar">
                        <span id="userInitialPopover"></span>
                    </div>
                    <div class="user-info">
                        <div class="user-name-popover" id="userNamePopover"></div>
                        <div class="user-email-popover" id="userEmailPopover"></div>
                    </div>
                </div>
                
                <div class="user-menu-divider"></div>
                
                <button class="user-menu-item" id="myAccountMenuBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Mon compte</span>
                </button>
                
                <button class="user-menu-item" id="userMenuAdminBtn" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    <span>Administrateur</span>
                </button>
                
                <button class="user-menu-item" id="userMenuUsageBtn" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    <span>Utilisation</span>
                </button>
                
                <button class="user-menu-item" id="appearanceMenuBtn">
                    <svg id="appearanceIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <!-- Icône mise à jour en JS -->
                    </svg>
                    <span>Apparence</span>
                </button>
                
                <button class="user-menu-item" id="logoutMenuBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Se déconnecter</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ✅ ÉTAPE 4: Modal Mon compte -->
    <div id="myAccountModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    ">
        <div style="
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        ">
            <h2 style="margin: 0 0 1.5rem 0; font-size: 1.5rem; font-weight: 600; color: var(--text-primary);">
                Mon compte
            </h2>
            
            <!-- ✅ ÉTAPE 5: Section Avatar -->
            <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <div id="accountAvatarPreview" style="
                    width: 100px;
                    height: 100px;
                    border-radius: 50%;
                    background: var(--accent-light);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 2.5rem;
                    font-weight: 600;
                    color: var(--accent);
                    overflow: hidden;
                ">
                    <!-- Initiale ou image -->
                </div>
                
                <input 
                    type="file" 
                    id="avatarFileInput" 
                    accept="image/*"
                    style="display: none;"
                >
                
                <button 
                    id="changeAvatarBtn"
                    style="
                        padding: 0.5rem 1rem;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: transparent;
                        color: var(--text-primary);
                        font-size: 0.875rem;
                        cursor: pointer;
                    "
                >
                    Changer la photo
                </button>
                
                <div id="avatarStatus" style="display: none; font-size: 0.75rem; color: var(--text-secondary);"></div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        Prénom
                    </label>
                    <input 
                        type="text" 
                        id="accountFirstName"
                        required
                        style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            font-size: 1rem;
                        "
                    >
                </div>
                
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        Nom
                    </label>
                    <input 
                        type="text" 
                        id="accountLastName"
                        required
                        style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            font-size: 1rem;
                        "
                    >
                </div>
                
                <!-- ✅ ÉTAPE 6: Section Sécurité -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">
                        Sécurité
                    </h3>
                    
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Nouveau mot de passe
                        </label>
                        <input 
                            type="password" 
                            id="newPassword"
                            minlength="6"
                            placeholder="Minimum 6 caractères"
                            style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 8px;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                font-size: 1rem;
                            "
                        >
                    </div>
                    
                    <button 
                        id="changePasswordBtn"
                        style="
                            width: 100%;
                            margin-top: 0.75rem;
                            padding: 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: transparent;
                            color: var(--text-primary);
                            font-size: 0.875rem;
                            cursor: pointer;
                        "
                    >
                        Changer le mot de passe
                    </button>
                    
                    <div id="passwordStatus" style="display: none; margin-top: 0.5rem; font-size: 0.75rem;"></div>
                </div>
                
                <!-- ✅ ÉTAPE 7: Section Données -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">
                        Données
                    </h3>
                    
                    <button 
                        id="deleteAllChatsBtn"
                        style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid rgb(239, 68, 68);
                            border-radius: 8px;
                            background: transparent;
                            color: rgb(239, 68, 68);
                            font-size: 0.875rem;
                            cursor: pointer;
                        "
                    >
                        Supprimer toutes mes conversations
                    </button>
                    
                    <div id="deleteChatsStatus" style="display: none; margin-top: 0.5rem; font-size: 0.75rem;"></div>
                </div>
                
                <div id="accountStatus" style="display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem;"></div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button 
                        id="cancelAccountBtn"
                        style="
                            flex: 1;
                            padding: 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 8px;
                            background: transparent;
                            color: var(--text-primary);
                            font-size: 1rem;
                            cursor: pointer;
                        "
                    >
                        Annuler
                    </button>
                    <button 
                        id="saveAccountBtn"
                        style="
                            flex: 1;
                            padding: 0.75rem;
                            border: none;
                            border-radius: 8px;
                            background: var(--accent);
                            color: white;
                            font-size: 1rem;
                            font-weight: 500;
                            cursor: pointer;
                        "
                    >
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-wrapper">
        <div class="chat-container" id="chatContainer">
            <div class="messages" id="messages">
                <div class="empty-state" id="emptyState">
                    <h2 id="greetingMessage"></h2>
                    <p>Posez n'importe quelle question sur votre entreprise, vos clients ou vos projets.</p>
                </div>
            </div>
        </div>

        <div class="input-container" id="chatInputContainer">
            <div class="input-center">
                <div class="input-wrapper">
                    <div class="file-badge-container" id="fileBadgeContainer">
                        <div class="file-preview" id="filePreview" style="display: none;">
                            <div class="file-preview-content">
                                <span class="file-preview-icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                        <polyline points="13 2 13 9 20 9"></polyline>
                                    </svg>
                                </span>
                                <span class="file-preview-name" id="filePreviewName"></span>
                                <button class="file-preview-remove" id="filePreviewRemove">✕</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-text-area">
                        <div class="input-scroll-area">
                            <button class="attach-button" id="attachButton">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                </svg>
                            </button>
                            
                            <div class="prompt-input-container">
                                <textarea 
                                    class="prompt-input" 
                                    id="chatInput" 
                                    placeholder="Posez votre question..."
                                    rows="1"
                                ></textarea>
                            </div>
                        </div>
                        
                        <div class="input-actions">
                            <button class="rag-toggle-btn" id="ragToggleBtn" aria-label="Toggle RAG">
                                <svg viewBox="0 0 24 24">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                            
                            <button class="mic-button" id="micButton">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                            </button>
                            
                            <button class="send-button" id="sendButton">
                                <svg viewBox="0 0 24 24">
                                    <line x1="12" y1="19" x2="12" y2="5"></line>
                                    <polyline points="5 12 12 5 19 12"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="rag-indicator" id="ragIndicator" style="display: none;">
                    🔍 RAG activé
                </div>
                
                <input type="file" id="chatAttachInput" style="display: none;">
                
                <div class="audio-visualizer" id="audioVisualizer">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>

                <div class="audio-controls" id="audioControls">
                    <button class="audio-cancel" id="audioCancelBtn" aria-label="Cancel recording">
                        <svg viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <button class="audio-submit" id="audioSubmitBtn" aria-label="Submit recording">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                </div>
                
                <!-- Message erreur limite tokens -->
                <div id="tokenLimitError" style="display: none; color: #EF4444; font-size: 0.875rem; margin-top: 0.5rem; padding: 0 0.5rem;">
                    <span id="charCount"></span> / 100,000 caractères
                </div>
                
                <!-- Disclaimer IA -->
                <p style="
                    text-align: center;
                    font-size: 0.75rem;
                    color: #64748B;
                    margin-top: 0.75rem;
                    opacity: 0.7;
                    font-weight: 400;
                ">
                    AIOS peut se tromper. Vérifiez les informations importantes.
                </p>
            </div>
        </div>
    </div>

    <div class="documents-page" id="documentsPage" style="display: none;">
        <div class="documents-header">
            <button class="back-btn" id="backToChat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour au chat
            </button>
            <h2>Gestion des Documents</h2>
        </div>

        <div class="documents-content">
            <div class="upload-section">
                <h3>Upload Document</h3>
                
                <div class="upload-zone" id="fileUploadZone">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p>Glissez un fichier ici ou cliquez pour sélectionner</p>
                    <input type="file" id="fileInput" style="display: none;">
                </div>

                <div class="text-upload">
                    <h4>ou saisir du texte directement</h4>
                    <input type="text" id="docName" placeholder="Nom du document" class="doc-name-input">
                    <textarea id="textInput" placeholder="Collez votre texte ici..." class="text-input"></textarea>
                    <button id="uploadTextBtn" class="upload-btn">Uploader le texte</button>
                </div>
            </div>

            <div class="documents-list-section">
                <h3>Documents uploadés</h3>
                <div id="documentsList" class="documents-list">
                    <div class="loading-docs">Chargement...</div>
                </div>
            </div>

            <div class="upload-status" id="uploadStatus" style="display: none;"></div>
        </div>
    </div>

    <!-- Admin Panel (Admin Only) -->
    <div class="documents-page" id="adminPanel" style="display: none;">
        <div class="documents-header">
            <button class="back-btn" id="backToChatFromAdmin">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour au chat
            </button>
            <h2>Administrateur</h2>
        </div>

        <div class="documents-content">
            <!-- Status Message -->
            <div id="settingsStatus" style="display: none; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"></div>

            <!-- Employees List Section -->
            <div class="upload-section">
                <h3 style="margin-bottom: 1.5rem;">👥 Employés</h3>
                
                <div id="employeesList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Chargement...
                    </p>
                </div>
            </div>

            <!-- Default Permissions Section -->
            <div class="upload-section" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">⚙️ Paramètres par défaut</h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    Ces permissions seront appliquées automatiquement aux nouveaux employés lors de leur inscription.
                </p>
                
                <div id="defaultPermissionsForm" style="display: flex; flex-direction: column; gap: 1rem;">
                    
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">🧠 Accès IA</h4>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="default_can_use_rag">
                            <span>Utiliser la recherche documentaire (RAG)</span>
                        </label>
                    </div>

                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">📄 Documents</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="default_can_upload_documents" checked>
                                <span>📤 Upload de documents</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="default_can_edit_documents">
                                <span>✏️ Édition de documents</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="default_can_delete_documents">
                                <span>🗑️ Suppression de documents</span>
                            </label>
                        </div>
                    </div>

                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">💬 Quota quotidien</h4>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="number" id="default_daily_message_quota"
                                min="1" max="999999" value="50"
                                style="border: 2px solid var(--border-color); border-radius: 8px; padding: 0.5rem; width: 120px;">
                            <span>messages / jour</span>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                                <input type="checkbox" id="default_unlimited">
                                <span>Illimité</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="saveDefaultPermissions()" class="upload-btn" style="margin-top: 1rem;">
                        Enregistrer les paramètres par défaut
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Panel (Admin Only) -->
    <div class="documents-page" id="usagePanel" style="display: none;">
        <div class="documents-header">
            <button class="back-btn" id="backToChatFromUsage">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Retour au chat
            </button>
            <h2>Utilisation Gemini API</h2>
        </div>

        <div class="documents-content">
            <!-- Analytics Gemini Section -->
            <div class="upload-section">
                <h3 style="margin-bottom: 1rem;">📊 Statistiques d'utilisation</h3>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    Suivi de la consommation du modèle IA Gemini
                </p>
                
                <div id="geminiStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Chargement...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">
                Permissions de <span id="modalUserName"></span>
            </h2>

            <div id="userPermissionsForm"></div>

            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button onclick="saveUserPermissions()" class="upload-btn" style="flex: 1;">
                    Enregistrer
                </button>
                <button onclick="closeUserModal()" class="upload-btn" style="flex: 1; background: var(--border-color); color: var(--text-primary);">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : 'https://aios-llm-backend.onrender.com';

        // ========== USER PERMISSIONS ==========
        let userPermissions = null;
        let userRole = null;
        let userFirstNameGlobal = ''; // Store first name globally
        let userEmailGlobal = ''; // Store email globally

        // Fonction pour mettre à jour le menu utilisateur
        function updateUserMenu() {
            const userName = document.getElementById('userName');
            const userInitial = document.getElementById('userInitial');
            const userNamePopover = document.getElementById('userNamePopover');
            const userInitialPopover = document.getElementById('userInitialPopover');
            const userEmailPopover = document.getElementById('userEmailPopover');
            
            // ✅ ÉTAPE 3: Utiliser currentUser directement
            const firstName = currentUser?.first_name || 'Utilisateur';
            const lastName = currentUser?.last_name || '';
            const email = currentUser?.email || '';
            const fullName = lastName ? `${firstName} ${lastName}` : firstName;
            
            // ✅ Initiales = première lettre prénom + première lettre nom
            const firstInitial = firstName.charAt(0).toUpperCase();
            const lastInitial = lastName ? lastName.charAt(0).toUpperCase() : '';
            const initials = firstInitial + lastInitial;
            
            // ✅ ÉTAPE 3: Gérer avatar_url depuis currentUser
            const avatarUrl = currentUser?.avatar_url || null;
            
            // Affichage prénom + nom
            if (userName) userName.textContent = fullName;
            if (userNamePopover) userNamePopover.textContent = fullName;
            if (userEmailPopover) userEmailPopover.textContent = email;
            
            // Affichage avatar/initiale (sidebar)
            if (userInitial) {
                if (avatarUrl) {
                    // Si avatar_url existe, afficher l'image
                    userInitial.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Avatar">`;
                } else {
                    // Sinon, afficher les initiales (AP)
                    userInitial.textContent = initials;
                }
            }
            
            // Affichage avatar/initiale (popover)
            if (userInitialPopover) {
                if (avatarUrl) {
                    userInitialPopover.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Avatar">`;
                } else {
                    userInitialPopover.textContent = initials;
                }
            }
        }

        // ========== THEME FUNCTIONS ==========
        
        function isDarkTheme() {
            return document.documentElement.getAttribute('data-theme') === 'dark';
        }

        function toggleTheme() {
            const isDark = isDarkTheme();

            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }

            updateAppearanceIcon();
        }

        function updateAppearanceIcon() {
            const icon = document.getElementById('appearanceIcon');
            if (!icon) return;

            if (isDarkTheme()) {
                // Lune
                icon.innerHTML = `
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                `;
            } else {
                // Soleil
                icon.innerHTML = `
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                `;
            }
        }

        // Initialisation thème au chargement
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        updateAppearanceIcon();

        // ========== SETTINGS DATA ==========
        let currentOrgId = null;
        let currentEditingUserId = null;
        let defaultOrgPermissions = {};
        let employees = [];

        // ========== AUTH HELPER FUNCTION ==========
        // ✅ AUTH ADDED
        async function getAuthHeaders() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/login.html';
                return {};
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            };
        }

        // ========== LOAD USER PERMISSIONS ==========
        async function loadUserPermissions() {
            try {
                // ✅ ÉTAPE 2: Utiliser currentUser au lieu de l'API backend
                if (!currentUser) {
                    throw new Error('currentUser non chargé');
                }

                console.log('📦 Utilisation profil public.users:', currentUser);
                
                // Extract role
                userRole = currentUser.role;
                
                // Extract first_name et last_name
                const firstName = currentUser.first_name || '';
                const lastName = currentUser.last_name || '';
                console.log('👤 Nom complet:', firstName, lastName);
                
                // Extract email
                const email = currentUser.email || '';
                userEmailGlobal = email;
                console.log('📧 Email:', email);
                
                // Store globally for reuse
                if (firstName) {
                    userFirstNameGlobal = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
                } else {
                    // Fallback: extract from email if no first_name
                    if (email) {
                        const emailName = email.split('@')[0];
                        userFirstNameGlobal = emailName.charAt(0).toUpperCase() + emailName.slice(1).toLowerCase();
                    }
                }
                
                // Update greeting with first name and time-based message
                updateGreeting();
                
                // Update user menu
                if (typeof updateUserMenu === 'function') {
                    updateUserMenu();
                }
                
                // Extract permissions directement depuis currentUser
                userPermissions = {
                    can_upload_docs: currentUser.can_upload_documents,
                    can_edit_docs: currentUser.can_edit_documents,
                    can_delete_docs: currentUser.can_delete_documents,
                    can_use_rag: currentUser.can_use_rag,
                    daily_prompt_limit: currentUser.daily_message_quota
                };

                console.log('✅ Permissions loaded:', { role: userRole, permissions: userPermissions });

                // Apply UI restrictions based on permissions
                applyPermissionsToUI();

            } catch (error) {
                console.error('Load permissions error:', error);
                // Default to most restrictive if error
                userPermissions = {
                    can_upload_docs: false,
                    can_edit_docs: false,
                    can_delete_docs: false,
                    can_use_rag: false,
                    daily_prompt_limit: 10,
                    
                    
                };
                userRole = 'employee';
            }
        }

        // Apply permissions to UI elements
        function applyPermissionsToUI() {
            // Documents button - show if admin OR has any document permission
            const documentsBtn = document.getElementById('documentsBtn');
            const hasDocPermission = (
                userRole === 'admin' ||
                userPermissions.can_upload_documents ||
                userPermissions.can_edit_documents ||
                userPermissions.can_delete_documents
            );
            
            if (hasDocPermission && documentsBtn) {
                documentsBtn.style.display = 'flex';
                console.log('✅ Documents button enabled');
            } else if (documentsBtn) {
                documentsBtn.style.display = 'none';
                console.log('❌ Documents button hidden (no permissions)');
            }

            // ✅ ÉTAPE 2: Afficher "Administrateur" et "Utilisation" pour les admins uniquement
            const userMenuAdminBtn = document.getElementById('userMenuAdminBtn');
            const userMenuUsageBtn = document.getElementById('userMenuUsageBtn');
            
            if (userRole === 'admin') {
                if (userMenuAdminBtn) userMenuAdminBtn.style.display = 'flex';
                if (userMenuUsageBtn) userMenuUsageBtn.style.display = 'flex';
            } else {
                if (userMenuAdminBtn) userMenuAdminBtn.style.display = 'none';
                if (userMenuUsageBtn) userMenuUsageBtn.style.display = 'none';
            }

            // RAG Toggle button - show for admins OR if explicit permission
            const ragToggleBtn = document.getElementById('ragToggleBtn');
            if ((userRole === 'admin' || userPermissions.can_use_rag) && ragToggleBtn) {
                ragToggleBtn.style.display = 'flex';
                console.log('✅ RAG button enabled');
            }

            // Upload controls
            const uploadZone = document.getElementById('fileUploadZone');
            const uploadTextBtn = document.getElementById('uploadTextBtn');
            const textInput = document.getElementById('textInput');
            const docName = document.getElementById('docName');

            if (!userPermissions.can_upload_docs) {
                if (uploadZone) {
                    uploadZone.style.opacity = '0.5';
                    uploadZone.style.pointerEvents = 'none';
                    uploadZone.innerHTML = '<p style="color: var(--text-secondary);">⛔ Vous n\'avez pas la permission d\'uploader des documents</p>';
                }
                if (uploadTextBtn) uploadTextBtn.disabled = true;
                if (textInput) textInput.disabled = true;
                if (docName) docName.disabled = true;
            }

            // Display quota info if limited
            if (userPermissions.daily_prompt_limit !== null) {
                displayQuotaInfo();
            }
        }

        // ✅ ÉTAPE 14: Affichage quota depuis données server
        function displayQuotaInfo() {
            const quotaDiv = document.createElement('div');
            quotaDiv.id = 'quotaInfo';
            quotaDiv.style.cssText = 'font-size: 0.875rem; color: var(--text-secondary); margin-right: 1rem;';
            quotaDiv.innerHTML = `📊 <span id="quotaCount">-</span>/<span id="quotaLimit">-</span>`;
            
            // Insert in header before buttons
            const header = document.querySelector('.header > div:last-child');
            if (header) {
                header.insertBefore(quotaDiv, header.firstChild);
            }
        }

        // ✅ ÉTAPE 14: Mettre à jour l'affichage quota avec données server
        function updateQuotaDisplay(used, limit) {
            const quotaCount = document.getElementById('quotaCount');
            const quotaLimit = document.getElementById('quotaLimit');
            
            if (!quotaCount || !quotaLimit) return;

            // Si limit = null → quota illimité
            if (limit === null) {
                quotaCount.textContent = used;
                quotaLimit.textContent = '∞';
                quotaCount.style.color = 'var(--text-secondary)';
                return;
            }

            // Afficher used / limit
            quotaCount.textContent = used;
            quotaLimit.textContent = limit;

            // Gestion couleur selon usage
            const percentage = used / limit;
            
            if (percentage >= 1) {
                quotaCount.style.color = '#ef4444'; // Rouge (quota atteint)
            } else if (percentage >= 0.9) {
                quotaCount.style.color = '#f59e0b'; // Orange (proche limite)
            } else if (percentage >= 0.7) {
                quotaCount.style.color = '#eab308'; // Jaune
            } else {
                quotaCount.style.color = 'var(--text-secondary)'; // Normal
            }
        }

        // ✅ ÉTAPE 14: Charger quota initial au chargement page
        async function initQuotaCount() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;

                // Appel endpoint pour récupérer quota actuel
                const response = await fetch(`${API_URL}/api/users/me/permissions`, {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const limit = data.permissions?.daily_message_quota;
                    
                    // Afficher limite (usage sera mis à jour au premier message)
                    const quotaLimit = document.getElementById('quotaLimit');
                    if (quotaLimit) {
                        if (limit === null) {
                            quotaLimit.textContent = '∞';
                        } else {
                            quotaLimit.textContent = limit;
                        }
                    }
                    
                    // Mettre à jour le compteur (0 par défaut au chargement)
                    const quotaCount = document.getElementById('quotaCount');
                    if (quotaCount) {
                        quotaCount.textContent = '0';
                    }
                }
            } catch (error) {
                console.error('❌ Erreur init quota:', error);
            }
        }

        // ✅ AUTH ADDED
        // Fonction typewriter pour animation du titre
        async function typeTextSmooth(element, text, speed = 35) {
            const span = element.querySelector('span') || element;
            span.textContent = "";
            element.classList.add("typing");

            for (let char of text) {
                span.textContent += char;
                await new Promise(r => setTimeout(r, speed));
            }

            element.classList.remove("typing");
        }

        async function loadChats(forceNewChat = false) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats`, { headers });
                const data = await response.json();
                
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = '';
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        const chatItem = createChatItem(chat);
                        chatsList.appendChild(chatItem);
                    });
                    
                    // Si forceNewChat = true, ne PAS charger automatiquement un chat
                    if (!currentChatId && !forceNewChat) {
                        const urlChatId = getCurrentChatIdFromUrl();
                        const targetId = urlChatId || data.chats[0].id;
                        await loadChat(targetId);
                    }
                } else {
                    await createNewChat();
                }
            } catch (error) {
                console.error('Load chats error:', error);
            }
        }

        function createChatItem(chat) {
            const chatWrapper = document.createElement('div');
            chatWrapper.className = 'chat-item-wrapper';
            
            const chatLink = document.createElement('a');
            chatLink.href = `/chat/${chat.id}`;
            chatLink.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
            chatLink.dataset.chatId = chat.id;
            chatLink.style.textDecoration = 'none';
            chatLink.style.display = 'flex';
            
            const menuId = `chat-menu-${chat.id}`;
            
            chatLink.innerHTML = `
                <div class="chat-item-title reveal" id="title-${chat.id}"><span>${chat.title}</span></div>
                <div class="chat-item-actions">
                    <button class="chat-menu-btn" data-menu-id="${menuId}" title="Actions">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="5" cy="12" r="1"></circle>
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                        </svg>
                    </button>
                </div>
            `;
            
            // Menu contextuel
            const contextMenu = document.createElement('div');
            contextMenu.id = menuId;
            contextMenu.className = 'chat-context-menu';
            contextMenu.innerHTML = `
                <button class="chat-context-menu-item" data-action="rename" data-chat-id="${chat.id}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Renommer
                </button>
                <button class="chat-context-menu-item delete" data-action="delete" data-chat-id="${chat.id}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Supprimer
                </button>
            `;
            
            chatWrapper.appendChild(chatLink);
            chatWrapper.appendChild(contextMenu);
            
            // Event: Ouvrir menu
            const menuBtn = chatLink.querySelector('.chat-menu-btn');
            menuBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Fermer tous les autres menus
                document.querySelectorAll('.chat-context-menu.active').forEach(m => {
                    if (m.id !== menuId) m.classList.remove('active');
                });
                
                // Toggle ce menu
                contextMenu.classList.toggle('active');
            });
            
            // Event: Actions du menu
            contextMenu.querySelectorAll('.chat-context-menu-item').forEach(item => {
                item.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const action = item.dataset.action;
                    const chatId = item.dataset.chatId;
                    
                    contextMenu.classList.remove('active');
                    
                    if (action === 'rename') {
                        startRenameChat(chatId);
                    } else if (action === 'delete') {
                        await deleteChat(chatId);
                    }
                });
            });
            
            // Afficher le titre directement (l'animation sera gérée par refreshSidebar si changement)
            setTimeout(() => {
                const titleEl = chatWrapper.querySelector(`#title-${chat.id}`);
                if (titleEl) {
                    const span = titleEl.querySelector('span');
                    if (span) span.textContent = chat.title;
                }
            }, 10);
            
            return chatWrapper;
        }
        
        // Fonction rename inline
        function startRenameChat(chatId) {
            const titleEl = document.getElementById(`title-${chatId}`);
            if (!titleEl) return;
            
            const span = titleEl.querySelector('span');
            const currentTitle = span ? span.textContent : titleEl.textContent;
            
            // Créer input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.style.cssText = `
                width: 100%;
                padding: 0;
                border: none;
                background: transparent;
                color: var(--text-primary);
                font-size: 0.875rem;
                outline: none;
            `;
            
            titleEl.innerHTML = '';
            titleEl.appendChild(input);
            input.focus();
            input.select();
            
            async function saveRename() {
                const newTitle = input.value.trim();
                if (!newTitle || newTitle === currentTitle) {
                    titleEl.innerHTML = `<span>${currentTitle}</span>`;
                    titleEl.classList.add('reveal');
                    return;
                }
                
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch(`${API_URL}/api/chats/${chatId}`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify({ title: newTitle })
                    });
                    
                    if (response.ok) {
                        // Animation reveal - MODIFIER span existant
                        const span = titleEl.querySelector('span');
                        if (span) {
                            titleEl.classList.remove('reveal');
                            span.textContent = newTitle;
                            span.getBoundingClientRect(); // Force reflow
                            titleEl.classList.add('reveal');
                        } else {
                            titleEl.innerHTML = `<span>${newTitle}</span>`;
                            titleEl.classList.add('reveal');
                        }
                        
                        console.log('✅ Chat renamed');
                    } else {
                        const span = titleEl.querySelector('span');
                        if (span) span.textContent = currentTitle;
                        else titleEl.innerHTML = `<span>${currentTitle}</span>`;
                        titleEl.classList.add('reveal');
                    }
                } catch (error) {
                    console.error('Rename error:', error);
                    const span = titleEl.querySelector('span');
                    if (span) span.textContent = currentTitle;
                    else titleEl.innerHTML = `<span>${currentTitle}</span>`;
                    titleEl.classList.add('reveal');
                }
            }
            
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    titleEl.innerHTML = `<span>${currentTitle}</span>`;
                    titleEl.classList.add('reveal');
                }
            });
        }

        // Fermer menus contextuels au clic extérieur
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-menu-btn') && !e.target.closest('.chat-context-menu')) {
                document.querySelectorAll('.chat-context-menu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // ✅ ÉTAPE 3: Greeting avec prénom depuis currentUser
        function updateGreeting() {
            const greetingEl = document.getElementById('greetingMessage');
            if (!greetingEl) return;
            
            const hour = new Date().getHours();
            const greeting = (hour >= 18 || hour < 4) ? 'Bonsoir' : 'Bonjour';
            const firstName = currentUser?.first_name || '';
            const name = firstName ? `, ${firstName}` : '';
            
            greetingEl.textContent = `${greeting}${name}.`;
        }

        async function createNewChat() {
            // Mode "draft" - Pas de création serveur avant le premier message
            // Juste vider l'interface et préparer pour nouveau chat
            
            // 1. Réinitialiser l'état
            currentChatId = null; // Pas de chat actif
            
            // 2. Vider les messages
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            // 3. Désactiver tous les chats dans la sidebar
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 4. Mettre à jour l'URL (état vierge)
            history.pushState({}, '', '/');
            
            // 5. Focus sur l'input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.focus();
            
            // Le chat sera créé automatiquement au premier message envoyé
        }

        // ✅ AUTH ADDED
        async function loadChat(chatId) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats/${chatId}`, { headers });
                const data = await response.json();
                
                currentChatId = chatId;
                updateUrl(chatId);
                
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.chatId === chatId);
                });
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        // Parser si fichier attaché (format: "📎 filename.ext\nTexte")
                        let file = null;
                        let text = msg.content;
                        
                        if (msg.role === 'user' && msg.content.startsWith('📎 ')) {
                            const lines = msg.content.split('\n');
                            const filename = lines[0].replace('📎 ', '').trim();
                            text = lines.slice(1).join('\n').trim();
                            file = { name: filename };
                        }
                        
                        addMessage(text, msg.role === 'user' ? 'user' : 'ai', file);
                    });
                } else {
                    showEmptyState();
                }
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Load chat error:', error);
            }
        }

        // ✅ AUTH ADDED
        // Popup de confirmation custom
        function customConfirm(title, message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customConfirm');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const cancelBtn = document.getElementById('confirmCancel');
                const okBtn = document.getElementById('confirmOk');

                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.classList.add('show');

                const cleanup = () => {
                    overlay.classList.remove('show');
                    cancelBtn.removeEventListener('click', onCancel);
                    okBtn.removeEventListener('click', onConfirm);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                cancelBtn.addEventListener('click', onCancel);
                okBtn.addEventListener('click', onConfirm);

                // Fermer avec Escape
                const onEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(false);
                        document.removeEventListener('keydown', onEscape);
                    }
                };
                document.addEventListener('keydown', onEscape);
            });
        }

        async function deleteChat(chatId) {
            const confirmed = await customConfirm(
                'Supprimer la conversation',
                'Cette action est irréversible. Toutes les messages seront définitivement supprimés.'
            );
            
            if (!confirmed) return;
            
            try {
                const headers = await getAuthHeaders();
                await fetch(`${API_URL}/api/chats/${chatId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                // Si c'était le chat actif, revenir à la page vierge
                if (currentChatId === chatId) {
                    currentChatId = null;
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    history.pushState({}, '', '/');
                }
                
                await loadChats();
            } catch (error) {
                console.error('Delete chat error:', error);
            }
        }

        // ✅ AUTH ADDED
        async function saveMessage(role, content) {
            // Le chat est créé automatiquement dans sendMessage() si besoin
            if (!currentChatId) {
                console.error('No chat ID - message not saved');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                
                await fetch(`${API_URL}/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ role, content })
                });
                
                // Refresh sidebar pour voir le titre auto-généré
                if (role === 'user') {
                    setTimeout(() => refreshSidebar(), 1500);
                }
            } catch (error) {
                console.error('Save message error:', error);
            }
        }
        
        // ✅ AUTH ADDED
        async function refreshSidebar() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_URL}/api/chats`, { headers });
                const data = await response.json();
                
                const chatsList = document.getElementById('chatsList');
                
                // Sauvegarder anciens titres pour détecter changements
                const oldTitles = new Map();
                chatsList.querySelectorAll('.chat-item').forEach(item => {
                    const chatId = item.dataset.chatId;
                    const titleEl = item.querySelector('.chat-item-title span');
                    if (titleEl) oldTitles.set(chatId, titleEl.textContent);
                });
                
                chatsList.innerHTML = '';
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        const chatItem = createChatItem(chat);
                        chatsList.appendChild(chatItem);
                        
                        // Animation si titre a changé
                        const oldTitle = oldTitles.get(chat.id);
                        if (oldTitle && oldTitle !== chat.title && chat.title !== 'Nouvelle conversation') {
                            setTimeout(() => {
                                const titleEl = chatItem.querySelector(`#title-${chat.id}`);
                                if (titleEl) typeTextSmooth(titleEl, chat.title);
                            }, 100);
                        }
                    });
                }
            } catch (error) {
                console.error('Refresh sidebar error:', error);
            }
        }

        const sidebar = document.querySelector('.sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
        }

        function showEmptyState() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="empty-state" id="emptyState">
                    <h2 id="greetingMessage"></h2>
                    <p>Posez n'importe quelle question sur votre entreprise, vos clients ou vos projets.</p>
                </div>
            `;
            
            // Update greeting based on time and first name
            updateGreeting();
        }

        // Nouveau Chat géré par le router maintenant
        document.getElementById('newChatBtn').addEventListener('click', async (e) => {
            if (e.metaKey || e.ctrlKey) {
                return; // Router gère ça
            }
            e.preventDefault();
            await createNewChat();
        });

        // ===== CLIENT-SIDE ROUTER =====
        // Gérer navigation sans rechargement page
        function handleRoute(path) {
            const appWrapper = document.querySelector('.app-wrapper');
            const documentsPage = document.getElementById('documentsPage');
            const adminPanel = document.getElementById('adminPanel');
            const usagePanel = document.getElementById('usagePanel');
            
            // Reset visibilité
            appWrapper.style.display = 'flex';
            documentsPage.style.display = 'none';
            if (adminPanel) adminPanel.style.display = 'none';
            if (usagePanel) usagePanel.style.display = 'none';
            
            // Route vers pages
            if (path === '/documents.html' || path === '/documents') {
                appWrapper.style.display = 'none';
                documentsPage.style.display = 'block';
                loadDocuments();
            } else if (path.startsWith('/chat/')) {
                const chatId = path.split('/chat/')[1];
                if (chatId) {
                    loadChat(chatId);
                }
            } else {
                // Home "/" = nouveau chat ou afficher existant
                // Ne rien faire, l'interface est déjà là
            }
        }
        
        // Fonctions pour afficher les panels
        function showAdminPanel() {
            const appWrapper = document.querySelector('.app-wrapper');
            const documentsPage = document.getElementById('documentsPage');
            const adminPanel = document.getElementById('adminPanel');
            const usagePanel = document.getElementById('usagePanel');
            
            appWrapper.style.display = 'none';
            documentsPage.style.display = 'none';
            if (usagePanel) usagePanel.style.display = 'none';
            if (adminPanel) {
                adminPanel.style.display = 'block';
                loadSettingsPage(); // Charge les employés et paramètres
            }
        }
        
        function showUsagePanel() {
            const appWrapper = document.querySelector('.app-wrapper');
            const documentsPage = document.getElementById('documentsPage');
            const adminPanel = document.getElementById('adminPanel');
            const usagePanel = document.getElementById('usagePanel');
            
            appWrapper.style.display = 'none';
            documentsPage.style.display = 'none';
            if (adminPanel) adminPanel.style.display = 'none';
            if (usagePanel) {
                usagePanel.style.display = 'block';
                loadGeminiStats(); // Charge les stats Gemini
            }
        }
        
        function returnToChat() {
            const appWrapper = document.querySelector('.app-wrapper');
            const documentsPage = document.getElementById('documentsPage');
            const adminPanel = document.getElementById('adminPanel');
            const usagePanel = document.getElementById('usagePanel');
            
            appWrapper.style.display = 'flex';
            documentsPage.style.display = 'none';
            if (adminPanel) adminPanel.style.display = 'none';
            if (usagePanel) usagePanel.style.display = 'none';
        }
        
        // Intercepter clics sur tous les liens internes
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            
            const href = link.getAttribute('href');
            if (!href || href.startsWith('http') || href.startsWith('#')) return;
            
            // Si Cmd/Ctrl+Clic, laisser navigateur ouvrir nouvel onglet
            if (e.metaKey || e.ctrlKey) {
                return;
            }
            
            // Sinon, navigation en AJAX
            e.preventDefault();
            window.history.pushState({}, '', href);
            handleRoute(href);
        });
        
        // Gérer boutons back/forward du navigateur
        window.addEventListener('popstate', () => {
            handleRoute(window.location.pathname);
        });
        
        // Charger route initiale au chargement page
        window.addEventListener('load', () => {
            handleRoute(window.location.pathname);
        });

        // ========== INITIALISATION DÉJÀ GÉRÉE DANS LE BOOTSTRAP CI-DESSUS ==========
        // L'initialisation complète (bootstrap + permissions + chats) est maintenant
        // gérée dans la IIFE principale en haut du fichier pour garantir l'ordre d'exécution

        window.addEventListener('hashchange', () => {
            const urlChatId = getCurrentChatIdFromUrl();
            if (urlChatId && urlChatId !== currentChatId) {
                loadChat(urlChatId);
            }
        });

        // Boutons retour
        const backToChat = document.getElementById('backToChat');
        const backToChatFromAdmin = document.getElementById('backToChatFromAdmin');
        const backToChatFromUsage = document.getElementById('backToChatFromUsage');
        
        if (backToChat) {
            backToChat.addEventListener('click', () => {
                returnToChat();
            });
        }
        
        if (backToChatFromAdmin) {
            backToChatFromAdmin.addEventListener('click', () => {
                returnToChat();
            });
        }
        
        if (backToChatFromUsage) {
            backToChatFromUsage.addEventListener('click', () => {
                returnToChat();
            });
        }

        async function loadDocuments() {
            const documentsList = document.getElementById('documentsList');
            documentsList.innerHTML = '<div class="loading-docs">Chargement...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/documents`);
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    documentsList.innerHTML = '';
                    data.documents.forEach(doc => {
                        const docItem = createDocumentItem(doc);
                        documentsList.appendChild(docItem);
                    });
                } else {
                    documentsList.innerHTML = '<div class="loading-docs">Aucun document uploadé</div>';
                }
            } catch (error) {
                console.error('Load documents error:', error);
                documentsList.innerHTML = '<div class="loading-docs" style="color: rgb(239, 68, 68);">Erreur chargement documents</div>';
            }
        }
        
        function createDocumentItem(doc) {
            const div = document.createElement('div');
            div.className = 'doc-item';
            
            const uploadDate = new Date(doc.uploadedAt).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            // Check permissions for edit/delete buttons
            const canEdit = userPermissions?.can_edit_docs ?? false;
            const canDelete = userPermissions?.can_delete_docs ?? false;
            
            div.innerHTML = `
                <div class="doc-info">
                    <div class="doc-name">${doc.source}</div>
                    <div class="doc-meta">
                        <span>📅 ${uploadDate}</span>
                        <span>📦 ${doc.chunkCount} chunk${doc.chunkCount > 1 ? 's' : ''}</span>
                    </div>
                </div>
                <div class="doc-actions">
                    ${canEdit ? `
                        <button class="doc-delete-btn" onclick="editDocument('${doc.id}')" style="background: transparent; border-color: var(--accent); color: var(--accent);">
                            Modifier
                        </button>
                    ` : ''}
                    ${canDelete ? `
                        <button class="doc-delete-btn" onclick="deleteDocument('${doc.id}')">
                            Supprimer
                        </button>
                    ` : ''}
                    ${!canEdit && !canDelete ? '<span style="color: var(--text-secondary); font-size: 0.875rem;">Lecture seule</span>' : ''}
                </div>
            `;
            
            return div;
        }
        
        async function editDocument(docId) {
            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.querySelector('.upload-section').scrollIntoView({ behavior: 'smooth' });
                    
                    docName.value = data.source;
                    textInput.value = data.text;
                    
                    textInput.dataset.editingId = docId;
                    
                    uploadTextBtn.textContent = 'Mettre à jour le document';
                    uploadTextBtn.style.background = '#f59e0b';
                    
                    showStatus(`📝 Édition de "${data.source}"`, 'success');
                } else {
                    showStatus(`❌ Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Edit document error:', error);
                showStatus(`❌ Erreur: ${error.message}`, 'error');
            }
        }
        
        async function deleteDocument(docId) {
            if (!confirm('Supprimer ce document définitivement ?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`✅ Document supprimé (${data.deletedChunks} chunks)`, 'success');
                    loadDocuments();
                } else {
                    showStatus(`❌ Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Delete document error:', error);
                showStatus(`❌ Erreur: ${error.message}`, 'error');
            }
        }

        const fileUploadZone = document.getElementById('fileUploadZone');
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const docName = document.getElementById('docName');
        const uploadTextBtn = document.getElementById('uploadTextBtn');
        const uploadStatus = document.getElementById('uploadStatus');

        fileUploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadZone.style.borderColor = 'var(--accent)';
            fileUploadZone.style.background = 'var(--bg-secondary)';
        });

        fileUploadZone.addEventListener('dragleave', () => {
            fileUploadZone.style.borderColor = '';
            fileUploadZone.style.background = '';
        });

        fileUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadZone.style.borderColor = '';
            fileUploadZone.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showStatus(`Upload de "${file.name}" en cours...`, 'success');
                
                const response = await fetch(`${API_URL}/api/upload-file`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`✅ ${data.message}`, 'success');
                    loadDocuments();
                    fileInput.value = '';
                } else {
                    showStatus(`❌ Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('File upload error:', error);
                showStatus(`❌ Erreur: ${error.message}`, 'error');
            }
        }

        uploadTextBtn.addEventListener('click', async () => {
            const text = textInput.value.trim();
            const name = docName.value.trim() || `doc-${Date.now()}`;
            const editingId = textInput.dataset.editingId;
            
            if (!text) {
                showStatus('Veuillez saisir du texte', 'error');
                return;
            }
            
            if (editingId) {
                uploadTextBtn.disabled = true;
                showStatus('Mise à jour en cours...', 'success');
                
                try {
                    await fetch(`${API_URL}/api/documents/${editingId}`, {
                        method: 'DELETE'
                    });
                    
                    const docId = editingId;
                    await uploadDocument(docId, text, name);
                    
                    setTimeout(() => {
                        showStatus('ℹ️ La mise à jour peut prendre ~1 minute (propagation Pinecone)', 'success');
                    }, 2000);
                    
                    delete textInput.dataset.editingId;
                    uploadTextBtn.textContent = 'Uploader le texte';
                    uploadTextBtn.style.background = '';
                    
                } catch (error) {
                    console.error('Update error:', error);
                    showStatus(`❌ Erreur mise à jour: ${error.message}`, 'error');
                    uploadTextBtn.disabled = false;
                }
            } else {
                const docId = `text-${Date.now()}-${name.replace(/[^a-z0-9]/gi, '-')}`;
                await uploadDocument(docId, text, name);
            }
        });

        async function uploadDocument(id, text, source) {
            uploadTextBtn.disabled = true;
            showStatus('Upload en cours...', 'success');
            
            try {
                const response = await fetch('http://localhost:3000/api/upload-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        text: text,
                        source: source
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`✅ Document "${source}" ajouté avec succès !`, 'success');
                    
                    textInput.value = '';
                    docName.value = '';
                    fileInput.value = '';
                    
                    loadDocuments();
                } else {
                    showStatus(`❌ Erreur: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus(`❌ Erreur: ${error.message}`, 'error');
            } finally {
                uploadTextBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 5000);
            }
        }

        function getCurrentChatIdFromUrl() {
            const hash = window.location.hash;
            const match = hash.match(/#\/chat\/([a-f0-9-]+)/);
            return match ? match[1] : null;
        }

        function updateUrl(chatId) {
            const newHash = chatId ? `#/chat/${chatId}` : '#/';
            window.location.hash = newHash;
        }

        const CHAT_API_URL = API_URL + '/api/chat';
        const conversationId = 'session-' + Date.now();

        let ragForceEnabled = false;
        const ragToggleBtn = document.getElementById('ragToggleBtn');
        const ragIndicator = document.getElementById('ragIndicator');

        ragToggleBtn.addEventListener('click', () => {
            ragForceEnabled = !ragForceEnabled;
            
            if (ragForceEnabled) {
                ragToggleBtn.classList.add('active');
                ragIndicator.style.display = 'block';
            } else {
                ragToggleBtn.classList.remove('active');
                ragIndicator.style.display = 'none';
            }
        });

        // ✅ ÉTAPE 10 + 12 + 14: Version avec authentification, gestion quota et affichage
        async function sendToGemini(userMessage) {
            let loadingId;
            try {
                loadingId = addLoadingMessage();

                // ✅ ÉTAPE 10: Récupérer token Supabase
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    removeLoadingMessage(loadingId);
                    addMessage("❌ Vous devez être connecté pour envoyer des messages.", 'ai');
                    return;
                }

                // Appel endpoint /api/generate avec auth
                const response = await fetch(`${API_URL}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        prompt: userMessage
                    })
                });

                removeLoadingMessage(loadingId);

                // Gestion erreur 401 (non authentifié)
                if (response.status === 401) {
                    addMessage("❌ Session expirée. Veuillez vous reconnecter.", 'ai');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }

                // ✅ ÉTAPE 12: Gestion erreur 403 (quota dépassé)
                if (response.status === 403) {
                    const errorData = await response.json();
                    
                    if (errorData.error === 'DAILY_QUOTA_EXCEEDED') {
                        addMessage(
                            `⛔ **Quota journalier atteint**\n\n` +
                            `Vous avez utilisé vos ${errorData.quota} messages quotidiens.\n\n` +
                            `Le quota se réinitialise à minuit. Revenez demain ! 🌙`,
                            'ai'
                        );
                        
                        // Désactiver input
                        const chatInput = document.getElementById('chatInput');
                        const sendButton = document.getElementById('sendButton');
                        if (chatInput) {
                            chatInput.disabled = true;
                            chatInput.placeholder = '⛔ Quota atteint - Revenez demain';
                        }
                        if (sendButton) {
                            sendButton.disabled = true;
                        }
                        
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.content;

                // Afficher réponse
                addMessage(aiResponse, 'ai');
                await saveMessage('assistant', aiResponse);

                // ✅ ÉTAPE 14: Mettre à jour affichage quota depuis la réponse server
                if (data.quota) {
                    updateQuotaDisplay(data.quota.used, data.quota.limit);
                }

            } catch (error) {
                console.error('❌ Erreur sendToGemini:', error);
                if (loadingId) removeLoadingMessage(loadingId);
                addMessage("Désolé, une erreur s'est produite. Veuillez réessayer.", 'ai');
            }
        }

        // Fonction message système (si pas déjà présente)
        function addSystemMessage(text, style) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '⚙️';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.style.cssText = style;
            content.innerHTML = marked.parse(text); // Support Markdown
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ❌ ÉTAPE 9: Fonction avec fichier temporairement désactivée (nécessite endpoint dédié)
        async function sendToGeminiWithFile(userMessage, file) {
            const loadingId = addLoadingMessage();
            removeLoadingMessage(loadingId);
            addMessage("❌ L'upload de fichiers est temporairement désactivé (ÉTAPE 9). Il sera réactivé dans les prochaines étapes.", 'ai');
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.id = 'loading-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<span style="opacity: 0.6;">En train d\'analyser...</span>';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
            return 'loading-message';
        }

        function removeLoadingMessage(id) {
            const loadingMsg = document.getElementById(id);
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messages');
        const emptyState = document.getElementById('emptyState');
        const chatContainer = document.getElementById('chatContainer');
        const attachButton = document.getElementById('attachButton');
        const chatAttachInput = document.getElementById('chatAttachInput');
        const filePreview = document.getElementById('filePreview');
        const filePreviewName = document.getElementById('filePreviewName');
        const filePreviewRemove = document.getElementById('filePreviewRemove');

        let attachedFile = null;
        
        // Restaurer draft au chargement
        const savedDraft = localStorage.getItem('chatDraft');
        if (savedDraft) {
            chatInput.value = savedDraft;
            // Forcer ajustement hauteur
            chatInput.style.height = 'auto';
            const newHeight = Math.min(chatInput.scrollHeight, 280);
            chatInput.style.height = newHeight + 'px';
            
            // Gérer overflow si nécessaire
            const inputTextArea = chatInput.closest('.input-text-area');
            if (chatInput.scrollHeight > 280) {
                chatInput.style.overflowY = 'auto';
                inputTextArea.classList.add('has-overflow');
            } else {
                chatInput.style.overflowY = 'hidden';
                inputTextArea.classList.remove('has-overflow');
            }
        }

        attachButton.addEventListener('click', () => {
            chatAttachInput.click();
        });

        chatAttachInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                attachedFile = e.target.files[0];
                filePreviewName.textContent = attachedFile.name;
                filePreview.style.display = 'flex';
            }
        });

        filePreviewRemove.addEventListener('click', () => {
            attachedFile = null;
            chatAttachInput.value = '';
            filePreview.style.display = 'none';
        });

        const inputWrapper = document.querySelector('.input-wrapper');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => {
                inputWrapper.classList.add('dragging');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            inputWrapper.addEventListener(eventName, () => {
                inputWrapper.classList.remove('dragging');
            }, false);
        });

        inputWrapper.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                attachedFile = files[0];
                filePreviewName.textContent = attachedFile.name;
                filePreview.style.display = 'flex';
                
                chatInput.focus();
            }
        }, false);

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = chatInput.scrollHeight + 'px';
            
            // Auto-save draft
            localStorage.setItem('chatDraft', chatInput.value);
            
            // Vérifier limite tokens (100K chars ≈ 25K tokens)
            const MAX_CHARS = 100000;
            const tokenLimitError = document.getElementById('tokenLimitError');
            const charCount = document.getElementById('charCount');
            const sendButton = document.getElementById('sendButton');
            
            if (chatInput.value.length > MAX_CHARS) {
                charCount.textContent = chatInput.value.length.toLocaleString('fr-FR');
                tokenLimitError.style.display = 'block';
                sendButton.disabled = true;
                sendButton.style.opacity = '0.4';
                sendButton.style.cursor = 'not-allowed';
            } else {
                tokenLimitError.style.display = 'none';
                sendButton.disabled = false;
                sendButton.style.opacity = '1';
                sendButton.style.cursor = 'pointer';
            }
        });

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Bloquer si limite dépassée
                const MAX_CHARS = 100000;
                if (chatInput.value.length <= MAX_CHARS) {
                    sendMessage();
                }
            }
        });

        sendButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
                if (currentTranscript.trim()) {
                    sendMessage();
                }
            } else {
                sendMessage();
            }
        });

        const micButton = document.getElementById('micButton');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const audioControls = document.getElementById('audioControls');
        
        let recognition = null;
        let isRecording = false;
        let currentTranscript = '';

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                micButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>`;
                sendButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>`;
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                currentTranscript = (finalTranscript + interimTranscript).trim();
                chatInput.value = currentTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                }
            };

            micButton.addEventListener('click', () => {
                if (isRecording) {
                    currentTranscript = '';
                    chatInput.value = '';
                    stopRecording();
                } else {
                    currentTranscript = '';
                    chatInput.value = '';
                    recognition.start();
                }
            });

            function stopRecording() {
                isRecording = false;
                recognition.stop();
                
                micButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>`;
                sendButton.innerHTML = `<svg viewBox="0 0 24 24">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>`;
            }
        } else {
            micButton.style.display = 'none';
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message && !attachedFile) return;

            // Si pas de chat actif, créer un nouveau chat MAINTENANT (premier message)
            if (!currentChatId) {
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch(`${API_URL}/api/chats`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ title: 'Nouvelle conversation' })
                    });
                    const data = await response.json();
                    currentChatId = data.chat.id;
                    updateUrl(currentChatId);
                } catch (error) {
                    console.error('Auto-create chat error:', error);
                    return;
                }
            }

            // Stocker fichier avant reset
            const fileToSend = attachedFile;
            
            // RESET IMMÉDIAT (avant tout traitement)
            chatInput.value = '';
            chatInput.style.height = 'auto';
            chatInput.blur(); // Enlever focus = supprimer border violet
            localStorage.removeItem('chatDraft'); // Clear draft
            
            // Retirer has-overflow pour gradient
            const inputTextArea = chatInput.closest('.input-text-area');
            if (inputTextArea) {
                inputTextArea.classList.remove('has-overflow');
            }
            
            if (attachedFile) {
                attachedFile = null;
                chatAttachInput.value = '';
                filePreview.style.display = 'none';
            }

            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.remove();
            }

            // Message sans emoji fichier (juste texte)
            addMessage(message, 'user', fileToSend);
            
            // Sauvegarder avec nom fichier pour historique
            let displayMessage = message;
            if (fileToSend) {
                displayMessage = `📎 ${fileToSend.name}\n${message}`;
            }
            await saveMessage('user', displayMessage);

            if (fileToSend) {
                await sendToGeminiWithFile(message, fileToSend);
            } else {
                await sendToGemini(message);
            }
        }

        function addMessage(text, sender, file = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'AI';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            // Si fichier attaché (message user), afficher badge avant texte
            if (sender === 'user' && file) {
                const fileBadge = document.createElement('div');
                fileBadge.className = 'message-file-badge';
                fileBadge.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <span>${file.name}</span>
                `;
                content.appendChild(fileBadge);
            }
            
            if (sender === 'ai') {
                const textDiv = document.createElement('div');
                textDiv.innerHTML = marked.parse(text);
                content.appendChild(textDiv);
            } else {
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                content.appendChild(textDiv);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            // Ajouter actions (heure + copier) au survol
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            actions.innerHTML = `
                <span class="message-time">${time}</span>
                <button class="message-copy-btn" onclick="copyMessageText(this)" title="Copier">
                    <svg viewBox="0 0 24 24">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            `;
            
            messageDiv.appendChild(actions);
            messagesContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function copyMessageText(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.message-content');
            const text = contentDiv.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                button.innerHTML = `<svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>`;
                setTimeout(() => {
                    button.innerHTML = `<svg viewBox="0 0 24 24">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>`;
                }, 1500);
            });
        }

        function useSuggestion(text) {
            chatInput.value = text;
            chatInput.focus();
            sendMessage();
        }

        // ✅ ÉTAPE 3: Code obsolète supprimé (user.email depuis auth)
        // L'affichage email est géré par updateUserMenu() depuis currentUser

        // ========== USER MENU ==========
        
        const userMenuTrigger = document.getElementById('userMenuTrigger');
        const userMenuPopover = document.getElementById('userMenuPopover');
        const logoutMenuBtn = document.getElementById('logoutMenuBtn');
        const appearanceMenuBtn = document.getElementById('appearanceMenuBtn');
        const userMenuAdminBtn = document.getElementById('userMenuAdminBtn');
        const userMenuUsageBtn = document.getElementById('userMenuUsageBtn');
        
        // Toggle menu
        userMenuTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = userMenuPopover.style.display === 'block';
            userMenuPopover.style.display = isOpen ? 'none' : 'block';
        });
        
        // Fermer menu si clic ailleurs
        document.addEventListener('click', (e) => {
            if (!userMenuPopover.contains(e.target) && e.target !== userMenuTrigger) {
                userMenuPopover.style.display = 'none';
            }
        });
        
        // Logout
        logoutMenuBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = '/login.html';
        });
        
        // Admin Panel
        if (userMenuAdminBtn) {
            userMenuAdminBtn.addEventListener('click', () => {
                userMenuPopover.style.display = 'none';
                showAdminPanel();
            });
        }
        
        // Usage Panel
        if (userMenuUsageBtn) {
            userMenuUsageBtn.addEventListener('click', () => {
                userMenuPopover.style.display = 'none';
                showUsagePanel();
            });
        }
        
        // Apparence (toggle thème sans fermer menu)
        if (appearanceMenuBtn) {
            appearanceMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Ne pas fermer le popover
                toggleTheme();
            });
        }

        // ========== ÉTAPE 4: MON COMPTE ==========
        
        const myAccountMenuBtn = document.getElementById('myAccountMenuBtn');
        const myAccountModal = document.getElementById('myAccountModal');
        const cancelAccountBtn = document.getElementById('cancelAccountBtn');
        const saveAccountBtn = document.getElementById('saveAccountBtn');
        const accountFirstName = document.getElementById('accountFirstName');
        const accountLastName = document.getElementById('accountLastName');
        const accountStatus = document.getElementById('accountStatus');
        
        // ✅ ÉTAPE 5: Avatar
        const accountAvatarPreview = document.getElementById('accountAvatarPreview');
        const avatarFileInput = document.getElementById('avatarFileInput');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const avatarStatus = document.getElementById('avatarStatus');

        // Fonction pour mettre à jour l'aperçu avatar dans le modal
        function updateAccountAvatar() {
            const avatarUrl = currentUser?.avatar_url;
            const firstName = currentUser?.first_name || 'U';
            const initial = firstName.charAt(0).toUpperCase();
            
            if (avatarUrl) {
                accountAvatarPreview.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Avatar">`;
            } else {
                accountAvatarPreview.textContent = initial;
            }
        }

        // Ouvrir modal "Mon compte"
        myAccountMenuBtn.addEventListener('click', () => {
            // Fermer le menu popover
            userMenuPopover.style.display = 'none';
            
            // Pré-remplir les champs avec currentUser
            accountFirstName.value = currentUser?.first_name || '';
            accountLastName.value = currentUser?.last_name || '';
            
            // ✅ ÉTAPE 5: Afficher avatar actuel
            updateAccountAvatar();
            
            // ✅ ÉTAPE 6: Réinitialiser champ password
            newPasswordInput.value = '';
            
            // Cacher status précédent
            accountStatus.style.display = 'none';
            avatarStatus.style.display = 'none';
            passwordStatus.style.display = 'none';
            deleteChatsStatus.style.display = 'none';
            
            // Afficher modal
            myAccountModal.style.display = 'flex';
        });

        // ✅ ÉTAPE 5: Bouton "Changer la photo"
        changeAvatarBtn.addEventListener('click', () => {
            avatarFileInput.click();
        });

        // ✅ ÉTAPE 5: Upload avatar
        avatarFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validation type fichier
            if (!file.type.startsWith('image/')) {
                avatarStatus.textContent = '❌ Fichier doit être une image';
                avatarStatus.style.display = 'block';
                avatarStatus.style.color = 'rgb(239, 68, 68)';
                return;
            }

            try {
                avatarStatus.textContent = '⏳ Upload en cours...';
                avatarStatus.style.display = 'block';
                avatarStatus.style.color = 'var(--text-secondary)';

                // Nom du fichier: avatars/{user_id}.png
                const fileExt = file.name.split('.').pop();
                const filePath = `${currentUser.id}.${fileExt}`;

                // Upload vers Supabase Storage
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        upsert: true // Écrase si existe déjà
                    });

                if (uploadError) {
                    throw uploadError;
                }

                console.log('✅ Avatar uploadé:', uploadData);

                // Récupérer l'URL publique
                const { data: urlData } = supabaseClient.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                const avatarUrl = urlData.publicUrl;
                console.log('✅ Avatar URL:', avatarUrl);

                // UPDATE public.users.avatar_url
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({ avatar_url: avatarUrl })
                    .eq('id', currentUser.id);

                if (updateError) {
                    throw updateError;
                }

                console.log('✅ avatar_url mis à jour dans public.users');

                // Mettre à jour currentUser
                currentUser.avatar_url = avatarUrl;

                // Rafraîchir UI
                updateAccountAvatar();
                updateUserMenu();

                avatarStatus.textContent = '✅ Photo mise à jour';
                avatarStatus.style.color = 'rgb(34, 197, 94)';

                // Réinitialiser input
                avatarFileInput.value = '';

            } catch (error) {
                console.error('❌ Erreur upload avatar:', error);
                avatarStatus.textContent = '❌ Impossible de charger la photo';
                avatarStatus.style.color = 'rgb(239, 68, 68)';
            }
        });

        // ✅ ÉTAPE 6: Changer le mot de passe
        const newPasswordInput = document.getElementById('newPassword');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const passwordStatus = document.getElementById('passwordStatus');

        changePasswordBtn.addEventListener('click', async () => {
            const newPassword = newPasswordInput.value.trim();

            // Validation
            if (!newPassword) {
                passwordStatus.textContent = '❌ Mot de passe requis';
                passwordStatus.style.display = 'block';
                passwordStatus.style.color = 'rgb(239, 68, 68)';
                return;
            }

            if (newPassword.length < 6) {
                passwordStatus.textContent = '❌ Minimum 6 caractères';
                passwordStatus.style.display = 'block';
                passwordStatus.style.color = 'rgb(239, 68, 68)';
                return;
            }

            try {
                // Désactiver bouton
                changePasswordBtn.disabled = true;
                changePasswordBtn.textContent = 'Modification en cours...';

                passwordStatus.textContent = '⏳ Mise à jour...';
                passwordStatus.style.display = 'block';
                passwordStatus.style.color = 'var(--text-secondary)';

                // Supabase Auth: updateUser password
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                console.log('✅ Mot de passe mis à jour dans Supabase Auth');

                // Succès
                passwordStatus.textContent = '✅ Mot de passe modifié avec succès';
                passwordStatus.style.color = 'rgb(34, 197, 94)';

                // Vider le champ
                newPasswordInput.value = '';

                // Réactiver bouton
                changePasswordBtn.disabled = false;
                changePasswordBtn.textContent = 'Changer le mot de passe';

            } catch (error) {
                console.error('❌ Erreur changement mot de passe:', error);

                passwordStatus.textContent = '❌ Impossible de modifier le mot de passe';
                passwordStatus.style.color = 'rgb(239, 68, 68)';

                changePasswordBtn.disabled = false;
                changePasswordBtn.textContent = 'Changer le mot de passe';
            }
        });

        // Fermer modal
        cancelAccountBtn.addEventListener('click', () => {
            myAccountModal.style.display = 'none';
        });

        // Sauvegarder modifications
        saveAccountBtn.addEventListener('click', async () => {
            try {
                const newFirstName = accountFirstName.value.trim();
                const newLastName = accountLastName.value.trim();

                // Validation
                if (!newFirstName || !newLastName) {
                    accountStatus.textContent = '❌ Prénom et nom requis';
                    accountStatus.style.display = 'block';
                    accountStatus.style.background = 'rgba(239, 68, 68, 0.1)';
                    accountStatus.style.color = 'rgb(239, 68, 68)';
                    return;
                }

                // Désactiver bouton pendant sauvegarde
                saveAccountBtn.disabled = true;
                saveAccountBtn.textContent = 'Enregistrement...';

                // UPDATE public.users
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({
                        first_name: newFirstName,
                        last_name: newLastName
                    })
                    .eq('id', currentUser.id);

                if (updateError) {
                    throw updateError;
                }

                console.log('✅ Profil mis à jour dans public.users');

                // Mettre à jour currentUser en JS
                currentUser.first_name = newFirstName;
                currentUser.last_name = newLastName;

                // Rafraîchir UI
                userFirstNameGlobal = newFirstName.charAt(0).toUpperCase() + newFirstName.slice(1).toLowerCase();
                updateUserMenu();
                updateGreeting();

                // Afficher succès
                accountStatus.textContent = '✅ Profil mis à jour avec succès';
                accountStatus.style.display = 'block';
                accountStatus.style.background = 'rgba(34, 197, 94, 0.1)';
                accountStatus.style.color = 'rgb(34, 197, 94)';

                // Réactiver bouton
                saveAccountBtn.disabled = false;
                saveAccountBtn.textContent = 'Enregistrer';

                // Fermer modal après 1 seconde
                setTimeout(() => {
                    myAccountModal.style.display = 'none';
                }, 1000);

            } catch (error) {
                console.error('❌ Erreur sauvegarde profil:', error);
                
                accountStatus.textContent = '❌ Impossible de sauvegarder les modifications';
                accountStatus.style.display = 'block';
                accountStatus.style.background = 'rgba(239, 68, 68, 0.1)';
                accountStatus.style.color = 'rgb(239, 68, 68)';

                saveAccountBtn.disabled = false;
                saveAccountBtn.textContent = 'Enregistrer';
            }
        });

        // ✅ ÉTAPE 7: Supprimer toutes mes conversations
        const deleteAllChatsBtn = document.getElementById('deleteAllChatsBtn');
        const deleteChatsStatus = document.getElementById('deleteChatsStatus');

        deleteAllChatsBtn.addEventListener('click', async () => {
            // Confirmation obligatoire
            const confirmed = confirm(
                'Cette action est définitive. Toutes vos conversations seront supprimées.\n\nÊtes-vous sûr de vouloir continuer ?'
            );

            if (!confirmed) {
                return;
            }

            try {
                // Désactiver bouton
                deleteAllChatsBtn.disabled = true;
                deleteAllChatsBtn.textContent = 'Suppression en cours...';

                deleteChatsStatus.textContent = '⏳ Suppression...';
                deleteChatsStatus.style.display = 'block';
                deleteChatsStatus.style.color = 'var(--text-secondary)';

                // DELETE tous les chats de l'utilisateur
                const { error } = await supabaseClient
                    .from('chats')
                    .delete()
                    .eq('user_id', currentUser.id);

                if (error) {
                    throw error;
                }

                console.log('✅ Tous les chats supprimés');

                // Mise à jour UI immédiate
                // 1. Vider liste conversations
                const chatsList = document.getElementById('chatsList');
                if (chatsList) {
                    chatsList.innerHTML = '';
                }

                // 2. Réinitialiser currentChatId
                currentChatId = null;
                localStorage.removeItem('currentChatId');

                // 3. Vider messages
                const messagesContainer = document.getElementById('messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state" id="emptyState">
                            <h2 id="greetingMessage"></h2>
                            <p>Posez n'importe quelle question sur votre entreprise, vos clients ou vos projets.</p>
                        </div>
                    `;
                    updateGreeting();
                }

                // 4. Message succès
                deleteChatsStatus.textContent = '✅ Toutes vos conversations ont été supprimées';
                deleteChatsStatus.style.color = 'rgb(34, 197, 94)';

                // Réactiver bouton
                deleteAllChatsBtn.disabled = false;
                deleteAllChatsBtn.textContent = 'Supprimer toutes mes conversations';

            } catch (error) {
                console.error('❌ Erreur suppression chats:', error);

                deleteChatsStatus.textContent = '❌ Impossible de supprimer les conversations';
                deleteChatsStatus.style.color = 'rgb(239, 68, 68)';

                deleteAllChatsBtn.disabled = false;
                deleteAllChatsBtn.textContent = 'Supprimer toutes mes conversations';
            }
        });

        // ========== SETTINGS FUNCTIONS ==========

        async function loadSettingsPage() {
            if (userRole !== 'admin') {
                showSettingsStatus('⛔ Accès réservé aux administrateurs', 'error');
                return;
            }

            await loadOrganizationData();
            await loadEmployeesList();
            await loadDefaultPermissions();
            await loadGeminiStats();
        }

        async function loadOrganizationData() {
            // ⚠️ DÉSACTIVÉ TEMPORAIREMENT
            // La colonne organization_id n'existe pas encore dans public.users
            // Cette fonction sera réactivée quand on introduira les organisations
            console.log('⏸️  loadOrganizationData() désactivée (pas d\'organisations pour l\'instant)');
            currentOrgId = null;
            return;
            
            /* CODE ORIGINAL (désactivé)
            try {
                console.log('🏢 loadOrganizationData()');
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    console.error('❌ Auth error', authError);
                    return;
                }
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('organization_id')
                    .eq('id', user.id)
                    .single();
                if (userError) {
                    console.error('❌ Failed to load user organization', userError);
                    return;
                }
                if (!userData?.organization_id) {
                    console.warn('⛔ User has no organization_id');
                    currentOrgId = null;
                    return;
                }
                // ✅ ASSIGNATION CRITIQUE
                currentOrgId = userData.organization_id;
                console.log('✅ currentOrgId set:', currentOrgId);
                // ⚠️ Permissions d'organisation : À charger PLUS TARD si besoin
                // (via une requête dédiée sur organizations)
            } catch (error) {
                console.error('🔥 Load organization error:', error);
            }
            */
        }

        function renderDefaultPermissionsForm() {
            const form = document.getElementById('defaultPermissionsForm');
            const unlimited = defaultOrgPermissions.daily_prompt_limit === null;
            
            form.innerHTML = `
                <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">📄 Documents</h4>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_upload_docs" ${defaultOrgPermissions.can_upload_docs ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut uploader des documents</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_edit_docs" ${defaultOrgPermissions.can_edit_docs ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut modifier les documents</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_delete_docs" ${defaultOrgPermissions.can_delete_docs ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut supprimer les documents</span>
                    </label>
                </div>

                <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">🔍 RAG</h4>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_use_rag" ${defaultOrgPermissions.can_use_rag ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut utiliser le RAG</span>
                    </label>
                </div>

                <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">💬 Usage</h4>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_unlimited" onchange="toggleDefaultLimit()" ${unlimited ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Usage illimité</span>
                    </label>
                    <div id="defaultLimitDiv" style="margin-top: 1rem; ${unlimited ? 'opacity: 0.4;' : ''}">
                        <label style="display: block; margin-bottom: 0.5rem;">Limite quotidienne :</label>
                        <input type="number" id="default_daily_prompt_limit" value="${defaultOrgPermissions.daily_prompt_limit || 50}" 
                            min="1" max="1000" ${unlimited ? 'disabled' : ''}
                            style="width: 120px; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                        <span style="margin-left: 0.5rem; color: var(--text-secondary);">prompts/jour</span>
                    </div>
                </div>

                <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">👥 Gestion</h4>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_view_analytics" ${defaultOrgPermissions.can_view_analytics ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut voir les analytics</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; cursor: pointer;">
                        <input type="checkbox" id="default_can_invite_users" ${defaultOrgPermissions.can_invite_users ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <span>Peut inviter d'autres employés</span>
                    </label>
                </div>
            `;
        }

        function toggleDefaultLimit() {
            const unlimited = document.getElementById('default_unlimited').checked;
            const limitDiv = document.getElementById('defaultLimitDiv');
            const limitInput = document.getElementById('default_daily_prompt_limit');
            
            if (unlimited) {
                limitDiv.style.opacity = '0.4';
                limitInput.disabled = true;
            } else {
                limitDiv.style.opacity = '1';
                limitInput.disabled = false;
            }
        }

        async function saveDefaultPermissions() {
            try {
                const unlimited = document.getElementById('default_unlimited').checked;
                
                const permissions = {
                    default_can_upload_docs: document.getElementById('default_can_upload_docs').checked,
                    default_can_edit_docs: document.getElementById('default_can_edit_docs').checked,
                    default_can_delete_docs: document.getElementById('default_can_delete_docs').checked,
                    default_can_use_rag: document.getElementById('default_can_use_rag').checked,
                    default_daily_prompt_limit: unlimited ? null : parseInt(document.getElementById('default_daily_prompt_limit').value)
                };

                const { error } = await supabaseClient
                    .from('organizations')
                    .update(permissions)
                    .eq('id', currentOrgId);

                if (error) throw error;

                showSettingsStatus('✅ Permissions par défaut mises à jour', 'success');
                defaultOrgPermissions = permissions;
                
            } catch (error) {
                console.error('Save permissions error:', error);
                showSettingsStatus('❌ Erreur sauvegarde', 'error');
            }
        }

        async function loadEmployeesList() {
            try {
                // Vérifier que currentOrgId existe
                if (!currentOrgId) {
                    console.warn('⛔ No currentOrgId - skipping employees load');
                    document.getElementById('employeesList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Aucune organisation trouvée</p>';
                    return;
                }

                console.log('🔍 Loading employees for org:', currentOrgId);

                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('organization_id', currentOrgId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                console.log('👥 Employees loaded from DB:', data);
                console.log('👥 Count:', data?.length);

                employees = data || [];
                
                console.log('👥 employees variable:', employees);
                console.log('👥 employees.length:', employees.length);
                
                renderEmployeesList();
                
            } catch (error) {
                console.error('Load employees error:', error);
                showSettingsStatus('Erreur chargement employés', 'error');
            }
        }

        async function loadDefaultPermissions() {
            try {
                if (!currentOrgId) return;

                const { data, error } = await supabaseClient
                    .from('organizations')
                    .select('default_can_use_rag, default_can_upload_documents, default_can_edit_documents, default_can_delete_documents, default_daily_message_quota')
                    .eq('id', currentOrgId)
                    .single();

                if (error) throw error;

                // Populate form with loaded values
                document.getElementById('default_can_use_rag').checked = data.default_can_use_rag || false;
                document.getElementById('default_can_upload_documents').checked = data.default_can_upload_documents ?? true;
                document.getElementById('default_can_edit_documents').checked = data.default_can_edit_documents || false;
                document.getElementById('default_can_delete_documents').checked = data.default_can_delete_documents || false;
                
                const quota = data.default_daily_message_quota || 50;
                document.getElementById('default_daily_message_quota').value = quota;
                document.getElementById('default_unlimited').checked = quota === 999999;

                console.log('✅ Default permissions loaded');

            } catch (error) {
                console.error('Load default permissions error:', error);
            }
        }

        async function saveDefaultPermissions() {
            try {
                if (!currentOrgId) {
                    showSettingsStatus('❌ Organisation introuvable', 'error');
                    return;
                }

                const unlimited = document.getElementById('default_unlimited').checked;

                const permissions = {
                    default_can_use_rag: document.getElementById('default_can_use_rag').checked,
                    default_can_upload_documents: document.getElementById('default_can_upload_documents').checked,
                    default_can_edit_documents: document.getElementById('default_can_edit_documents').checked,
                    default_can_delete_documents: document.getElementById('default_can_delete_documents').checked,
                    default_daily_message_quota: unlimited ? 999999 : parseInt(document.getElementById('default_daily_message_quota').value)
                };

                const { error } = await supabaseClient
                    .from('organizations')
                    .update(permissions)
                    .eq('id', currentOrgId);

                if (error) throw error;

                showSettingsStatus('✅ Paramètres par défaut enregistrés', 'success');
                console.log('✅ Default permissions saved:', permissions);

            } catch (error) {
                console.error('Save default permissions error:', error);
                showSettingsStatus('❌ Erreur sauvegarde paramètres', 'error');
            }
        }

        async function loadGeminiStats() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                const response = await fetch(`${API_URL}/api/stats/gemini`, {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load stats');

                const stats = await response.json();

                // Format numbers
                const formatNumber = (num) => num.toLocaleString('fr-FR');
                const formatCost = (cost) => `$${parseFloat(cost).toFixed(4)}`;

                const statsContainer = document.getElementById('geminiStats');
                statsContainer.innerHTML = `
                    <!-- Aujourd'hui -->
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📊 Aujourd'hui
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Requêtes:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.today.requests)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tokens input:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.today.input_tokens)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tokens output:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.today.output_tokens)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Coût estimé:</span>
                                <span style="font-weight: 600; color: #10b981;">${formatCost(stats.today.cost)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ce mois -->
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📈 Ce mois
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Requêtes:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.month.requests)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tokens input:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.month.input_tokens)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tokens output:</span>
                                <span style="font-weight: 600;">${formatNumber(stats.month.output_tokens)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Coût total:</span>
                                <span style="font-weight: 600; color: #10b981;">${formatCost(stats.month.cost)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ⚙️ Configuration
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Modèle:</span>
                                <span style="font-weight: 600;">${stats.model.name}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tarif input:</span>
                                <span style="font-weight: 600;">${stats.model.pricing.input}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tarif output:</span>
                                <span style="font-weight: 600;">${stats.model.pricing.output}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Limites API -->
                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            💡 Limites API (Tier 1)
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Par minute (RPM):</span>
                                <span style="font-weight: 600;">${stats.limits.rpm}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Par jour (RPD):</span>
                                <span style="font-weight: 600;">${stats.limits.rpd}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Tokens/min (TPM):</span>
                                <span style="font-weight: 600;">${stats.limits.tpm}</span>
                            </div>
                        </div>
                    </div>
                `;

                console.log('✅ Gemini stats loaded');

            } catch (error) {
                console.error('Load Gemini stats error:', error);
                document.getElementById('geminiStats').innerHTML = 
                    '<p style="color: #ef4444; text-align: center; padding: 2rem;">Erreur chargement statistiques</p>';
            }
        }

        function renderEmployeesList() {
            const list = document.getElementById('employeesList');
            
            console.log('🎨 renderEmployeesList called');
            console.log('🎨 employees:', employees);
            console.log('🎨 employees.length:', employees.length);
            
            if (employees.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Aucun employé</p>';
                return;
            }

            list.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-primary); border-bottom: 2px solid var(--border-color);">
                            <th style="text-align: left; padding: 1rem; font-weight: 600;">Nom</th>
                            <th style="text-align: left; padding: 1rem; font-weight: 600;">Email</th>
                            <th style="text-align: left; padding: 1rem; font-weight: 600;">Rôle</th>
                            <th style="text-align: left; padding: 1rem; font-weight: 600;">Quota</th>
                            <th style="text-align: left; padding: 1rem; font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${employees.map(emp => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 1rem;">${emp.first_name || '-'}</td>
                                <td style="padding: 1rem;">${emp.email}</td>
                                <td style="padding: 1rem;">
                                    <span style="padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.875rem; background: ${emp.role === 'admin' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; color: ${emp.role === 'admin' ? '#3B82F6' : '#6B7280'};">
                                        ${emp.role === 'admin' ? 'Admin' : 'Employé'}
                                    </span>
                                </td>
                                <td style="padding: 1rem;">${emp.daily_message_quota === 999999 ? 'Illimité' : (emp.daily_message_quota || 50) + '/jour'}</td>
                                <td style="padding: 1rem;">
                                    ${emp.role === 'employee' ? `
                                        <button onclick="editUser('${emp.id}')" style="padding: 0.5rem 1rem; background: transparent; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary); font-size: 0.875rem;">
                                            Modifier
                                        </button>
                                    ` : '<span style="color: var(--text-secondary);">-</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function editUser(userId) {
            const user = employees.find(e => e.id === userId);
            if (!user) return;

            currentEditingUserId = userId;
            document.getElementById('modalUserName').textContent = user.first_name || user.email;

            // ✅ Valeurs effectives avec FALLBACK HARD-CODÉ
            const effective = {
                can_use_rag: user.can_use_rag ?? true,
                can_upload_documents: user.can_upload_documents ?? false,
                can_edit_documents: user.can_edit_documents ?? false,
                can_delete_documents: user.can_delete_documents ?? false,
                daily_message_quota: user.daily_message_quota ?? 50
            };

            const form = document.getElementById('userPermissionsForm');
            form.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">

                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">🧠 Accès IA</h4>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="perm_can_use_rag" ${effective.can_use_rag ? 'checked' : ''}>
                            <span>Utiliser la recherche documentaire (RAG)</span>
                        </label>
                    </div>

                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem;">📄 Documents</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="perm_can_upload_documents" ${effective.can_upload_documents ? 'checked' : ''}>
                                <span>📤 Upload de documents</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="perm_can_edit_documents" ${effective.can_edit_documents ? 'checked' : ''}>
                                <span>✏️ Édition de documents</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="perm_can_delete_documents" ${effective.can_delete_documents ? 'checked' : ''}>
                                <span>🗑️ Suppression de documents</span>
                            </label>
                        </div>
                    </div>

                    <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">💬 Quota quotidien</h4>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="number" id="perm_daily_message_quota"
                                min="1" max="999999"
                                value="${effective.daily_message_quota}"
                                style="border: 2px solid var(--border-color); border-radius: 8px; padding: 0.5rem; width: 120px;">
                            <span>messages / jour</span>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                                <input type="checkbox" id="perm_unlimited" ${effective.daily_message_quota === 999999 ? 'checked' : ''}>
                                <span>Illimité</span>
                            </label>
                        </div>
                    </div>

                </div>
            `;

            document.getElementById('editUserModal').style.display = 'flex';
        }

        function toggleUserPermission(type, currentValue) {
            const div = document.getElementById(`user_${type}_div`);
            const checkbox = document.getElementById(`user_override_${type}`);
            if (checkbox.checked) {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        }

        function toggleUserQuota() {
            const div = document.getElementById('userLimitDiv');
            const checkbox = document.getElementById('user_custom_quota');
            div.style.display = checkbox.checked ? 'block' : 'none';
        }

        async function saveUserPermissions() {
            try {
                if (!currentEditingUserId) return;

                const unlimited = document.getElementById('perm_unlimited').checked;

                const payload = {
                    can_use_rag: document.getElementById('perm_can_use_rag').checked,
                    can_upload_documents: document.getElementById('perm_can_upload_documents').checked,
                    can_edit_documents: document.getElementById('perm_can_edit_documents').checked,
                    can_delete_documents: document.getElementById('perm_can_delete_documents').checked,
                    daily_message_quota: unlimited
                        ? 999999
                        : parseInt(document.getElementById('perm_daily_message_quota').value || 50)
                };

                const { data: { session } } = await supabaseClient.auth.getSession();

                const response = await fetch(`${API_URL}/api/users/${currentEditingUserId}/permissions`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erreur sauvegarde');
                }

                showSettingsStatus('✅ Permissions mises à jour', 'success');
                closeUserModal();
                await loadEmployeesList();

            } catch (error) {
                console.error('Save permissions error:', error);
                showSettingsStatus('❌ Impossible de sauvegarder les permissions', 'error');
            }
        }

        function closeUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            currentEditingUserId = null;
        }

        function showSettingsStatus(message, type) {
            const status = document.getElementById('settingsStatus');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' 
                ? 'rgba(34, 197, 94, 0.1)' 
                : 'rgba(239, 68, 68, 0.1)';
            status.style.border = type === 'success'
                ? '1px solid rgba(34, 197, 94, 0.3)'
                : '1px solid rgba(239, 68, 68, 0.3)';
            status.style.color = type === 'success'
                ? 'rgb(34, 197, 94)'
                : 'rgb(239, 68, 68)';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

    </script>
</body>
</html>