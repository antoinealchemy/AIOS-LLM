<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS - Inscription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .step { display: none; }
        .step.active { 
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
        <!-- Progress Bar -->
        <div class="mb-6">
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="progress-bar h-full bg-blue-500" style="width: 16.66%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">√âtape <span id="currentStep">1</span> sur <span id="totalSteps">6</span></p>
        </div>

        <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">Bienvenue sur AIOS</h1>
        <p class="text-gray-600 text-center mb-8">Cr√©ons votre compte ensemble</p>

        <!-- STEP 1: Pr√©nom -->
        <div class="step active" data-step="1">
            <label class="block text-lg font-medium mb-3 text-gray-700">Comment vous appelez-vous ?</label>
            <input type="text" id="firstName" 
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                placeholder="Votre pr√©nom"
                autofocus>
            <button onclick="nextStep()" class="w-full mt-6 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                Continuer ‚Üí
            </button>
        </div>

        <!-- STEP 2: Email -->
        <div class="step" data-step="2">
            <label class="block text-lg font-medium mb-3 text-gray-700">Quel est votre email ?</label>
            <input type="email" id="email" 
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                placeholder="votre@email.com">
            <div class="flex gap-3 mt-6">
                <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- STEP 3: Password -->
        <div class="step" data-step="3">
            <label class="block text-lg font-medium mb-3 text-gray-700">Choisissez un mot de passe</label>
            <input type="password" id="password" minlength="6"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                placeholder="Minimum 6 caract√®res">
            <p class="text-xs text-gray-500 mt-2">Au moins 6 caract√®res pour votre s√©curit√©</p>
            <div class="flex gap-3 mt-6">
                <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- STEP 4: Cr√©er ou Rejoindre Organisation -->
        <div class="step" data-step="4">
            <label class="block text-lg font-medium mb-4 text-gray-700">Vous √™tes...</label>
            
            <div class="space-y-3">
                <button onclick="selectRole('create')" 
                    class="role-btn w-full p-4 border-2 border-gray-300 rounded-xl hover:border-blue-500 text-left transition">
                    <div class="font-medium text-gray-800">üë®‚Äçüíº Je cr√©e mon organisation</div>
                    <div class="text-sm text-gray-500 mt-1">Vous serez administrateur</div>
                </button>
                
                <button onclick="selectRole('join')" 
                    class="role-btn w-full p-4 border-2 border-gray-300 rounded-xl hover:border-blue-500 text-left transition">
                    <div class="font-medium text-gray-800">üë§ Je rejoins une organisation existante</div>
                    <div class="text-sm text-gray-500 mt-1">Vous serez employ√©</div>
                </button>
            </div>

            <button onclick="prevStep()" class="w-full mt-6 px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                ‚Üê Retour
            </button>
        </div>

        <!-- STEP 5.1: Admin - Company Name + Admin Code -->
        <div class="step" data-step="5-admin" id="adminStep">
            <label class="block text-lg font-medium mb-3 text-gray-700">Nom de votre organisation</label>
            <input type="text" id="companyName" 
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg mb-4"
                placeholder="Cabinet Rousseau">
            
            <label class="block text-lg font-medium mb-3 text-gray-700">Code administrateur</label>
            <input type="password" id="adminCode" 
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                placeholder="Code secret fourni">
            <p class="text-xs text-gray-500 mt-2">Code fourni par AIOS pour cr√©er une organisation</p>
            
            <div class="flex gap-3 mt-6">
                <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- STEP 5.2: Employee - Organization Code -->
        <div class="step" data-step="5-employee" id="employeeStep">
            <label class="block text-lg font-medium mb-3 text-gray-700">Code d'organisation</label>
            <input type="text" id="orgCode" 
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                placeholder="ORG-ABCD1"
                style="text-transform: uppercase;">
            <p class="text-xs text-gray-500 mt-2">Code fourni par votre administrateur</p>
            
            <div class="flex gap-3 mt-6">
                <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- STEP 6: Permissions (Admin only) -->
        <div class="step" data-step="6" id="permissionsStep">
            <label class="block text-lg font-medium mb-4 text-gray-700">Permissions par d√©faut</label>
            <p class="text-sm text-gray-500 mb-4">Ces permissions s'appliqueront √† tous vos employ√©s</p>
            
            <div class="space-y-3">
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_upload" checked class="w-5 h-5">
                    <span>üì§ Upload documents</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_edit" class="w-5 h-5">
                    <span>‚úèÔ∏è Modifier documents</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_delete" class="w-5 h-5">
                    <span>üóëÔ∏è Supprimer documents</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_rag" checked class="w-5 h-5">
                    <span>üîç Utiliser RAG</span>
                </label>

                <div class="p-3 border rounded-lg">
                    <label class="flex items-center gap-3 mb-2">
                        <input type="checkbox" id="perm_unlimited" class="w-5 h-5" onchange="toggleQuotaLimit()">
                        <span>‚ôæÔ∏è Usage illimit√©</span>
                    </label>
                    <div id="quotaLimitDiv" class="ml-8">
                        <label class="text-sm text-gray-600">Limite quotidienne:</label>
                        <input type="number" id="perm_quota" value="50" min="1" max="1000" 
                            class="w-24 px-2 py-1 border rounded mt-1">
                        <span class="text-sm text-gray-500 ml-2">prompts/jour</span>
                    </div>
                </div>
                
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_analytics" class="w-5 h-5">
                    <span>üìä Voir analytics</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="perm_invite" class="w-5 h-5">
                    <span>üë• Inviter employ√©s</span>
                </label>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50">
                    ‚Üê Retour
                </button>
                <button onclick="finalizeSignup()" id="submitBtn" class="flex-1 bg-green-500 text-white py-3 rounded-xl hover:bg-green-600 font-medium">
                    Cr√©er mon compte ‚ú®
                </button>
            </div>
        </div>

        <!-- Message -->
        <div id="message" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ziirnaesezunusjbfqmn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppaXJuYWVzZXp1bnVzamJmcW1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NjcwMTMsImV4cCI6MjA1MDU0MzAxM30.8HCd_MG_EnD_wh7XOLBKidWJmYOGAqEW1zNCNR-z4Gw';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStep = 1;
        let selectedRole = null;
        const totalSteps = 6;

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentStep').textContent = currentStep;
        }

        function nextStep() {
            // Validations
            if (currentStep === 1 && !document.getElementById('firstName').value.trim()) {
                showMessage('Veuillez saisir votre pr√©nom', 'error');
                return;
            }

            if (currentStep === 2 && !document.getElementById('email').value.trim()) {
                showMessage('Veuillez saisir votre email', 'error');
                return;
            }

            if (currentStep === 3 && document.getElementById('password').value.length < 6) {
                showMessage('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }

            if (currentStep === 4 && !selectedRole) {
                showMessage('Veuillez s√©lectionner votre r√¥le', 'error');
                return;
            }

            if (currentStep === 5) {
                if (selectedRole === 'admin') {
                    if (!document.getElementById('companyName').value.trim() || 
                        !document.getElementById('adminCode').value.trim()) {
                        showMessage('Veuillez remplir tous les champs', 'error');
                        return;
                    }
                } else {
                    if (!document.getElementById('orgCode').value.trim()) {
                        showMessage('Veuillez saisir le code organisation', 'error');
                        return;
                    }
                }

                if (selectedRole === 'employee') {
                    finalizeSignup();
                    return;
                }
            }

            // Cacher √©tape actuelle
            if (currentStep === 5) {
                document.getElementById('adminStep').classList.remove('active');
                document.getElementById('employeeStep').classList.remove('active');
            } else {
                document
                    .querySelectorAll(`[data-step="${currentStep}"]`)
                    .forEach(el => el.classList.remove('active'));
            }

            // Logique de navigation
            if (currentStep === 4) {
                currentStep = 5;
            } else if (currentStep === 5 && selectedRole === 'employee') {
                finalizeSignup();
                return;
            } else if (currentStep === 5 && selectedRole === 'admin') {
                currentStep = 6;
            } else {
                currentStep++;
            }

            // Afficher √©tape suivante
            if (currentStep === 5) {
                if (selectedRole === 'admin') {
                    document.getElementById('adminStep').classList.add('active');
                } else {
                    document.getElementById('employeeStep').classList.add('active');
                }
            } else {
                document
                    .querySelectorAll(`[data-step="${currentStep}"]`)
                    .forEach(el => el.classList.add('active'));
            }

            updateProgress();
        }

        function prevStep() {
            // Cacher √©tape actuelle
            if (currentStep === 5) {
                document.getElementById('adminStep').classList.remove('active');
                document.getElementById('employeeStep').classList.remove('active');
            } else {
                document
                    .querySelectorAll(`[data-step="${currentStep}"]`)
                    .forEach(el => el.classList.remove('active'));
            }

            if (currentStep === 6) {
                currentStep = 5;
            } else if (currentStep === 5) {
                currentStep = 4;
            } else {
                currentStep--;
            }

            // Afficher √©tape pr√©c√©dente
            if (currentStep === 5) {
                if (selectedRole === 'admin') {
                    document.getElementById('adminStep').classList.add('active');
                } else {
                    document.getElementById('employeeStep').classList.add('active');
                }
            } else {
                document
                    .querySelectorAll(`[data-step="${currentStep}"]`)
                    .forEach(el => el.classList.add('active'));
            }

            updateProgress();
        }

        function selectRole(choice) {
            if (choice === 'create') {
                selectedRole = 'admin';
            } else {
                selectedRole = 'employee';
            }
            nextStep();
        }

        function toggleQuotaLimit() {
            const unlimited = document.getElementById('perm_unlimited').checked;
            const quotaDiv = document.getElementById('quotaLimitDiv');
            const quotaInput = document.getElementById('perm_quota');
            
            if (unlimited) {
                quotaDiv.style.opacity = '0.4';
                quotaInput.disabled = true;
            } else {
                quotaDiv.style.opacity = '1';
                quotaInput.disabled = false;
            }
        }

        async function finalizeSignup() {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Cr√©ation en cours...';
            }

            try {
                const firstName = document.getElementById('firstName').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                // Cr√©er compte Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: firstName,
                            first_name: firstName
                        }
                    }
                });

                if (authError) throw authError;
                if (!authData.user) throw new Error('Aucun utilisateur cr√©√©');

                console.log('‚úÖ Auth user cr√©√©:', authData.user.id);

                // Attendre que le trigger DB cr√©e l'entr√©e dans users
                await new Promise(resolve => setTimeout(resolve, 2000));

                // V√©rifier que l'utilisateur existe dans la table users
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', authData.user.id)
                    .single();

                if (userError) {
                    console.error('‚ùå User not found in DB:', userError);
                    throw new Error('Erreur lors de la cr√©ation du profil utilisateur');
                }

                console.log('‚úÖ User cr√©√© dans DB:', userData);

                // Succ√®s
                showMessage(`‚úÖ Compte cr√©√© avec succ√®s ! R√¥le: ${userData.role}`, 'success');
                setTimeout(() => window.location.href = 'index.html', 1500);

            } catch (error) {
                console.error('Signup error:', error);
                showMessage('‚ùå ' + error.message, 'error');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Cr√©er mon compte ‚ú®';
                }
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => messageDiv.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>