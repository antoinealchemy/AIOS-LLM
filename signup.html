<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS - Inscription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">‚ú® AIOS</h1>
            <p class="text-gray-600 mt-2" id="stepTitle">Cr√©ez votre compte</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-xs text-gray-500">√âtape <span id="currentStep">1</span>/4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
            </div>
        </div>

        <!-- √âTAPE 1: Email + Password -->
        <div id="step1" class="step">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="email" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="votre@email.com">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" id="password" required minlength="6"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="Minimum 6 caract√®res">
            </div>

            <button onclick="nextStep()" class="w-full bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                Continuer ‚Üí
            </button>
        </div>

        <!-- √âTAPE 2: Pr√©nom + Nom -->
        <div id="step2" class="step hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pr√©nom</label>
                <input type="text" id="firstName" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="Votre pr√©nom">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                <input type="text" id="lastName" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="Votre nom">
            </div>

            <div class="flex gap-3">
                <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 font-medium">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- √âTAPE 3: Choix Admin/Employ√© -->
        <div id="step3" class="step hidden">
            <p class="text-sm text-gray-600 mb-4">Vous √™tes :</p>

            <div class="space-y-3 mb-6">
                <div onclick="selectRole('admin')" id="adminCard" 
                    class="role-card border-2 border-gray-300 rounded-xl p-4 cursor-pointer hover:border-blue-500 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-gray-800">üëë Administrateur</h3>
                            <p class="text-sm text-gray-600">Cr√©er une nouvelle organisation</p>
                        </div>
                        <div class="role-check hidden">‚úì</div>
                    </div>
                </div>

                <div onclick="selectRole('employee')" id="employeeCard"
                    class="role-card border-2 border-gray-300 rounded-xl p-4 cursor-pointer hover:border-blue-500 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-gray-800">üë§ Employ√©</h3>
                            <p class="text-sm text-gray-600">Rejoindre une organisation existante</p>
                        </div>
                        <div class="role-check hidden">‚úì</div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 font-medium">
                    ‚Üê Retour
                </button>
                <button onclick="nextStep()" id="step3NextBtn" disabled 
                    class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <!-- √âTAPE 4A: Admin - Nom entreprise + Code -->
        <div id="step4Admin" class="step hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nom de l'entreprise</label>
                <input type="text" id="companyName" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="Ex: Cabinet Dupont">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Code administrateur</label>
                <input type="password" id="adminCode" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                    placeholder="Code fourni par AIOS">
                <p class="text-xs text-gray-500 mt-1">Code secret pour cr√©er une organisation</p>
            </div>

            <div class="flex gap-3">
                <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 font-medium">
                    ‚Üê Retour
                </button>
                <button onclick="finalizeSignup()" id="submitBtn" 
                    class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Cr√©er mon organisation ‚ú®
                </button>
            </div>
        </div>

        <!-- √âTAPE 4B: Employ√© - Code organisation -->
        <div id="step4Employee" class="step hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Code organisation</label>
                <input type="text" id="orgCode" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none uppercase"
                    placeholder="ORG-XXXXX"
                    style="text-transform: uppercase;">
                <p class="text-xs text-gray-500 mt-1">Code fourni par votre administrateur</p>
            </div>

            <div class="flex gap-3">
                <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 font-medium">
                    ‚Üê Retour
                </button>
                <button onclick="finalizeSignup()" id="submitBtn2"
                    class="flex-1 bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 font-medium">
                    Rejoindre l'organisation ‚ú®
                </button>
            </div>
        </div>

        <div id="message" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

        <p class="text-center text-gray-600 text-sm mt-6">
            D√©j√† inscrit ? <a href="login.html" class="text-blue-500 hover:underline font-medium">Se connecter</a>
        </p>
    </div>

    <script>
        const SUPABASE_URL = 'https://oxjocjucvlifcogphttm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9janVjdmxpZmNvZ3BodHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTk4NDEsImV4cCI6MjA4MTc5NTg0MX0.Fg9r0RSt-KSkePeIVIBCdVydPIcLsdWFa6D7V5bMT6E';
        const API_URL = 'https://aios-llm-backend.onrender.com';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStep = 1;
        let selectedRole = null;
        let authUserId = null;

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `mt-4 p-3 rounded-lg text-sm ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => messageDiv.classList.add('hidden'), 5000);
        }

        function updateProgress() {
            document.getElementById('currentStep').textContent = currentStep;
            document.getElementById('progressBar').style.width = (currentStep * 25) + '%';

            const titles = {
                1: 'Cr√©ez votre compte',
                2: 'Informations personnelles',
                3: 'Type de compte',
                4: selectedRole === 'admin' ? 'Cr√©er votre organisation' : 'Rejoindre une organisation'
            };
            document.getElementById('stepTitle').textContent = titles[currentStep];
        }

        function selectRole(role) {
            selectedRole = role;
            
            // Reset cards
            document.getElementById('adminCard').classList.remove('border-blue-500', 'bg-blue-50');
            document.getElementById('employeeCard').classList.remove('border-blue-500', 'bg-blue-50');
            document.querySelectorAll('.role-check').forEach(el => el.classList.add('hidden'));

            // Highlight selected
            const card = role === 'admin' ? document.getElementById('adminCard') : document.getElementById('employeeCard');
            card.classList.add('border-blue-500', 'bg-blue-50');
            card.querySelector('.role-check').classList.remove('hidden');

            // Enable next button
            document.getElementById('step3NextBtn').disabled = false;
        }

        function nextStep() {
            // Validation
            if (currentStep === 1) {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (!email || !password || password.length < 6) {
                    showMessage('Email et mot de passe (min 6 caract√®res) requis', 'error');
                    return;
                }
            }

            if (currentStep === 2) {
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                if (!firstName || !lastName) {
                    showMessage('Pr√©nom et nom requis', 'error');
                    return;
                }
            }

            if (currentStep === 3 && !selectedRole) {
                showMessage('Veuillez choisir un type de compte', 'error');
                return;
            }

            // Hide current step
            document.getElementById(`step${currentStep}`).classList.add('hidden');

            // Next step
            currentStep++;
            
            // Show next step
            if (currentStep === 4) {
                if (selectedRole === 'admin') {
                    document.getElementById('step4Admin').classList.remove('hidden');
                } else {
                    document.getElementById('step4Employee').classList.remove('hidden');
                }
            } else {
                document.getElementById(`step${currentStep}`).classList.remove('hidden');
            }

            updateProgress();
        }

        function prevStep() {
            // Hide current step
            if (currentStep === 4) {
                if (selectedRole === 'admin') {
                    document.getElementById('step4Admin').classList.add('hidden');
                } else {
                    document.getElementById('step4Employee').classList.add('hidden');
                }
            } else {
                document.getElementById(`step${currentStep}`).classList.add('hidden');
            }

            currentStep--;
            document.getElementById(`step${currentStep}`).classList.remove('hidden');
            updateProgress();
        }

        async function finalizeSignup() {
            const submitBtn = selectedRole === 'admin' ? document.getElementById('submitBtn') : document.getElementById('submitBtn2');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Cr√©ation en cours...';

            try {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();

                // 1. Cr√©er compte Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password
                });

                if (authError) throw authError;
                if (!authData.user) throw new Error('Cr√©ation compte √©chou√©e');

                authUserId = authData.user.id;
                console.log('‚úÖ Auth user created:', authUserId);

                // 2. Ins√©rer IMM√âDIATEMENT dans public.users
                const { error: insertError } = await supabaseClient
                    .from('users')
                    .insert({
                        id: authUserId,
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        role: selectedRole,
                        can_upload_documents: true,
                        can_view_analytics: false,
                        can_manage_users: selectedRole === 'admin',
                        daily_message_quota: 50
                    });

                if (insertError) {
                    console.error('‚ùå ERREUR CRITIQUE: Insertion public.users √©chou√©e:', insertError);
                    throw new Error('Impossible de cr√©er le profil utilisateur. Veuillez r√©essayer.');
                }

                console.log('‚úÖ User inserted in public.users');

                // 3. Obtenir le token de session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error('Session non trouv√©e');

                // 4. Cr√©er/Rejoindre organisation via backend
                if (selectedRole === 'admin') {
                    const companyName = document.getElementById('companyName').value.trim();
                    const adminCode = document.getElementById('adminCode').value.trim();

                    const response = await fetch(`${API_URL}/api/users/signup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            auth_user_id: authUserId,
                            email: email,
                            first_name: firstName,
                            last_name: lastName,
                            role: 'admin',
                            company_name: companyName,
                            admin_code: adminCode
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur cr√©ation organisation');
                    }

                    showMessage(`‚úÖ Organisation cr√©√©e ! Code: ${data.org_code}`, 'success');
                    console.log('Organization code:', data.org_code);

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);

                } else {
                    // Employee
                    const orgCode = document.getElementById('orgCode').value.trim();

                    const response = await fetch(`${API_URL}/api/organizations/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            org_code: orgCode
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur rejoindre organisation');
                    }

                    showMessage('‚úÖ Compte cr√©√© avec succ√®s !', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }

            } catch (error) {
                console.error('Signup error:', error);
                showMessage('‚ùå ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = selectedRole === 'admin' ? 'Cr√©er mon organisation ‚ú®' : 'Rejoindre l\'organisation ‚ú®';
            }
        }

        updateProgress();
    </script>

    <style>
        .role-check {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
    </style>
</body>
</html>