<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS - Param√®tres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-blue-600">‚ú® AIOS</a>
                    <span class="ml-4 text-gray-600">Param√®tres</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="logout()" class="text-gray-600 hover:text-gray-900">
                        D√©connexion
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <nav class="space-y-2">
                        <button onclick="showTab('profile')" id="tabProfile" class="tab-btn w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100">
                            üë§ Profil
                        </button>
                        <button onclick="showTab('organization')" id="tabOrganization" class="tab-btn w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100">
                            üè¢ Organisation
                        </button>
                        <button onclick="showTab('team')" id="tabTeam" class="tab-btn hidden w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100">
                            üë• √âquipe (Admin)
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Content -->
            <div class="lg:col-span-3">
                <!-- PROFIL TAB -->
                <div id="profileTab" class="tab-content">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">Informations personnelles</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="userEmail" disabled 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pr√©nom</label>
                                <input type="text" id="userFirstName" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">R√¥le</label>
                                <div class="px-4 py-2 bg-gray-100 rounded-lg">
                                    <span id="userRole" class="font-semibold"></span>
                                </div>
                            </div>

                            <button onclick="updateProfile()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                Enregistrer
                            </button>
                        </div>
                    </div>

                    <!-- Mes permissions -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
                        <h3 class="text-xl font-bold mb-4">Mes permissions</h3>
                        <div id="userPermissions" class="space-y-2">
                            <!-- Permissions charg√©es dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- ORGANISATION TAB -->
                <div id="organizationTab" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">Information organisation</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nom de l'organisation</label>
                                <div class="px-4 py-2 bg-gray-100 rounded-lg">
                                    <span id="orgName" class="font-semibold"></span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Code organisation</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="orgCode" readonly
                                        class="flex-1 px-4 py-2 bg-gray-100 rounded-lg font-mono">
                                    <button onclick="copyOrgCode()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        Copier
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Partagez ce code avec vos employ√©s pour qu'ils rejoignent l'organisation</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre d'employ√©s</label>
                                <div class="px-4 py-2 bg-gray-100 rounded-lg">
                                    <span id="employeeCount" class="font-semibold">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TEAM TAB (Admin only) -->
                <div id="teamTab" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Gestion de l'√©quipe</h2>
                            <button onclick="loadTeamMembers()" class="text-blue-500 hover:text-blue-600">
                                üîÑ Actualiser
                            </button>
                        </div>

                        <!-- Liste des membres -->
                        <div id="teamMembersList" class="space-y-4">
                            <!-- Membres charg√©s dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Modifier Permissions -->
    <div id="permissionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Modifier les permissions</h3>
                    <button onclick="closePermissionsModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>

                <div class="mb-4">
                    <p class="text-sm text-gray-600">Utilisateur: <strong id="modalUserName"></strong></p>
                </div>

                <!-- Permissions checkboxes -->
                <div class="space-y-4">
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold mb-3">Permissions principales</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="perm_can_use_rag" class="w-4 h-4">
                                <span>Utiliser RAG (recherche documentaire)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="perm_can_manage_documents" class="w-4 h-4">
                                <span>G√©rer les documents</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="perm_can_view_analytics" class="w-4 h-4">
                                <span>Voir les analytics</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="perm_can_invite_users" class="w-4 h-4">
                                <span>Inviter des utilisateurs</span>
                            </label>
                        </div>
                    </div>

                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold mb-3">Quota quotidien</h4>
                        <div class="flex items-center gap-4">
                            <input type="number" id="perm_daily_quota" min="1" max="999999" 
                                class="px-4 py-2 border rounded-lg w-32">
                            <span class="text-sm text-gray-600">messages par jour</span>
                            <label class="flex items-center gap-2 ml-auto">
                                <input type="checkbox" id="perm_unlimited" onchange="toggleUnlimitedQuota()">
                                <span class="text-sm">Illimit√©</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closePermissionsModal()" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Annuler
                    </button>
                    <button onclick="savePermissions()" 
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oxjocjucvlifcogphttm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94am9janVjdmxpZmNvZ3BodHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTk4NDEsImV4cCI6MjA4MTc5NTg0MX0.Fg9r0RSt-KSkePeIVIBCdVydPIcLsdWFa6D7V5bMT6E';
        const API_URL = 'https://aios-llm-backend.onrender.com';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentOrganization = null;
        let selectedUserId = null;

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            await loadUserData();
            await loadOrganizationData();
            showTab('profile');
        }

        async function loadUserData() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                const response = await fetch(`${API_URL}/api/users/me/permissions`, {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                const data = await response.json();
                
                currentUser = {
                    email: data.permissions.email,
                    first_name: data.permissions.first_name,
                    role: data.role
                };

                // Fill profile
                document.getElementById('userEmail').value = currentUser.email;
                document.getElementById('userFirstName').value = currentUser.first_name || '';
                document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'üëë Administrateur' : 'üë§ Employ√©';

                // Show permissions
                const permsHtml = `
                    <div class="flex items-center gap-2 py-2">
                        <span class="${data.permissions.can_use_rag ? 'text-green-600' : 'text-gray-400'}">
                            ${data.permissions.can_use_rag ? '‚úì' : '‚úó'}
                        </span>
                        <span>Utiliser RAG</span>
                    </div>
                    <div class="flex items-center gap-2 py-2">
                        <span class="${data.permissions.can_manage_documents ? 'text-green-600' : 'text-gray-400'}">
                            ${data.permissions.can_manage_documents ? '‚úì' : '‚úó'}
                        </span>
                        <span>G√©rer documents</span>
                    </div>
                    <div class="flex items-center gap-2 py-2">
                        <span class="${data.permissions.can_view_analytics ? 'text-green-600' : 'text-gray-400'}">
                            ${data.permissions.can_view_analytics ? '‚úì' : '‚úó'}
                        </span>
                        <span>Voir analytics</span>
                    </div>
                    <div class="flex items-center gap-2 py-2">
                        <span class="${data.permissions.can_invite_users ? 'text-green-600' : 'text-gray-400'}">
                            ${data.permissions.can_invite_users ? '‚úì' : '‚úó'}
                        </span>
                        <span>Inviter utilisateurs</span>
                    </div>
                    <div class="flex items-center gap-2 py-2">
                        <span class="text-blue-600">üìä</span>
                        <span>Quota: ${data.permissions.daily_message_quota === 999999 ? 'Illimit√©' : data.permissions.daily_message_quota + '/jour'}</span>
                    </div>
                `;
                document.getElementById('userPermissions').innerHTML = permsHtml;

                // Show team tab if admin
                if (currentUser.role === 'admin') {
                    document.getElementById('tabTeam').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Load user error:', error);
                alert('Erreur chargement profil');
            }
        }

        async function loadOrganizationData() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { data: userData } = await supabaseClient
                    .from('users')
                    .select('organization_id, organizations(name, org_code)')
                    .eq('id', user.id)
                    .single();

                if (userData && userData.organizations) {
                    const org = userData.organizations;
                    currentOrganization = org;
                    
                    document.getElementById('orgName').textContent = org.name;
                    document.getElementById('orgCode').value = org.org_code;

                    // Count employees
                    const { count } = await supabaseClient
                        .from('users')
                        .select('*', { count: 'exact', head: true })
                        .eq('organization_id', userData.organization_id);
                    
                    document.getElementById('employeeCount').textContent = count || 0;
                }
            } catch (error) {
                console.error('Load org error:', error);
            }
        }

        // REMPLACE LA FONCTION loadTeamMembers() DANS settings.html (ligne ~329)
        // Par cette version corrig√©e:

        async function loadTeamMembers() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('organization_id')
                    .eq('id', user.id)
                    .single();

                if (userError || !userData || !userData.organization_id) {
                    console.error('User or organization not found');
                    document.getElementById('teamMembersList').innerHTML = '<p class="text-gray-500">Aucune organisation trouv√©e</p>';
                    return;
                }

                const { data: members, error: membersError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('organization_id', userData.organization_id)
                    .order('created_at', { ascending: false });

                if (membersError) {
                    throw membersError;
                }

                if (!members || members.length === 0) {
                    document.getElementById('teamMembersList').innerHTML = '<p class="text-gray-500">Aucun membre</p>';
                    return;
                }

                const html = members.map(member => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold">${member.first_name || member.email}</h4>
                                    <span class="text-xs px-2 py-1 rounded ${member.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}">
                                        ${member.role === 'admin' ? 'üëë Admin' : 'üë§ Employ√©'}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">${member.email}</p>
                                <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    <span>${member.can_use_rag ? '‚úì RAG' : '‚úó RAG'}</span>
                                    <span>${member.can_manage_documents ? '‚úì Docs' : '‚úó Docs'}</span>
                                    <span>Quota: ${member.daily_message_quota === 999999 ? '‚àû' : member.daily_message_quota}</span>
                                </div>
                            </div>
                            ${member.role !== 'admin' ? `
                                <button onclick="openPermissionsModal('${member.id}', '${member.email}')" 
                                    class="px-4 py-2 text-blue-500 hover:bg-blue-50 rounded-lg">
                                    ‚öôÔ∏è Modifier
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('teamMembersList').innerHTML = html;

            } catch (error) {
                console.error('Load team error:', error);
                alert('Erreur chargement √©quipe: ' + error.message);
            }
        }

        async function openPermissionsModal(userId, userEmail) {
            selectedUserId = userId;
            document.getElementById('modalUserName').textContent = userEmail;

            // Load current permissions
            const { data: user } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();

            if (user) {
                document.getElementById('perm_can_use_rag').checked = user.can_use_rag || false;
                document.getElementById('perm_can_manage_documents').checked = user.can_manage_documents || false;
                document.getElementById('perm_can_view_analytics').checked = user.can_view_analytics || false;
                document.getElementById('perm_can_invite_users').checked = user.can_invite_users || false;
                document.getElementById('perm_daily_quota').value = user.daily_message_quota || 50;
                document.getElementById('perm_unlimited').checked = user.daily_message_quota === 999999;
            }

            document.getElementById('permissionsModal').classList.remove('hidden');
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').classList.add('hidden');
            selectedUserId = null;
        }

        function toggleUnlimitedQuota() {
            const unlimited = document.getElementById('perm_unlimited').checked;
            const quotaInput = document.getElementById('perm_daily_quota');
            
            if (unlimited) {
                quotaInput.value = 999999;
                quotaInput.disabled = true;
            } else {
                quotaInput.value = 50;
                quotaInput.disabled = false;
            }
        }

        async function savePermissions() {
            try {
                const updates = {
                    can_use_rag: document.getElementById('perm_can_use_rag').checked,
                    can_manage_documents: document.getElementById('perm_can_manage_documents').checked,
                    can_view_analytics: document.getElementById('perm_can_view_analytics').checked,
                    can_invite_users: document.getElementById('perm_can_invite_users').checked,
                    daily_message_quota: parseInt(document.getElementById('perm_daily_quota').value)
                };

                const { error } = await supabaseClient
                    .from('users')
                    .update(updates)
                    .eq('id', selectedUserId);

                if (error) throw error;

                alert('‚úÖ Permissions mises √† jour');
                closePermissionsModal();
                loadTeamMembers();

            } catch (error) {
                console.error('Save permissions error:', error);
                alert('‚ùå Erreur sauvegarde');
            }
        }

        function showTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-blue-100', 'text-blue-600', 'font-semibold');
            });

            // Show selected tab
            document.getElementById(`${tab}Tab`).classList.remove('hidden');
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('bg-blue-100', 'text-blue-600', 'font-semibold');

            // Load data if team tab
            if (tab === 'team') {
                loadTeamMembers();
            }
        }

        function copyOrgCode() {
            const code = document.getElementById('orgCode').value;
            navigator.clipboard.writeText(code);
            alert('‚úÖ Code copi√© !');
        }

        async function updateProfile() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const firstName = document.getElementById('userFirstName').value;

                const { error } = await supabaseClient
                    .from('users')
                    .update({ first_name: firstName })
                    .eq('id', user.id);

                if (error) throw error;

                alert('‚úÖ Profil mis √† jour');
                loadUserData();

            } catch (error) {
                console.error('Update profile error:', error);
                alert('‚ùå Erreur mise √† jour');
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>